<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026 ËªäÊµÅÈÄÄÂ†¥‰ΩúÊ•≠Á≥ªÁµ±</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* =========================================
       1. Design Tokens & Colors
       ========================================= */
    :root {
      /* Brand Colors */
      --c-brand: #1f6fe5;       /* ‰∏ªËâ≤Ëóç */
      --c-brand-dark: #1e40af;  /* Ê∑±Ëóç (Active) */
      
      /* Functional Colors */
      --c-success: #22c55e;     /* ‰øÆÊîπ/Á∂† */
      --c-danger: #ef4444;      /* Âà™Èô§/Á¥Ö */
      --c-neutral: #64748b;     /* Áï•ÈÅé/ÁÅ∞ */
      --c-dark: #334155;        /* Á≥ªÁµ±/Ê∑±ÁÅ∞ */

      /* Theme Colors */
      --c-teal: #059669;
      --c-orange: #f97316;
      --c-purple: #7c3aed;
      --c-pink: #db2777;

      /* UI Bases */
      --bg-body: #e5e7eb;
      --bg-app: #f8fafc;
      --bg-surface: #ffffff;
      --border: #e2e8f0;
      
      /* Text */
      --text-main: #0f172a;
      --text-sub: #64748b;

      /* Metrics */
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-pill: 50px;
      --app-max-width: 800px; 
      
      /* Layers */
      --z-bottom: 1100;
      --z-overlay: 1000;
      --z-header: 500;
    }

    body { 
      margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      background: var(--bg-body); color: var(--text-main); 
      padding-bottom: 0; -webkit-tap-highlight-color: transparent;
    }

    /* App Shell */
    #appView {
      max-width: var(--app-max-width); margin: 0 auto;
      background-color: var(--bg-app); min-height: 100vh;
      box-shadow: 0 0 30px rgba(0,0,0,0.1); padding-bottom: 80px; 
    }

    .container { padding: 16px; }

    /* =========================================
       2. Header & Navigation (Grid Layout)
       ========================================= */
    .app-header {
      background: var(--bg-surface); padding: 12px 16px;
      position: sticky; top: 0; z-index: var(--z-header);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: grid;
      grid-template-columns: 1fr auto 1fr; /* Left - Center - Right */
      align-items: center; gap: 8px;
    }

    /* Left: Title */
    .app-title { font-size: 1.1rem; font-weight: 800; color: var(--c-brand); white-space: nowrap; }

    /* Center: Time (Monospace for stability) */
    .header-clock { 
      font-family: monospace; font-size: 1.1rem; font-weight: 800; 
      color: var(--text-main); white-space: nowrap; 
    }

    /* Right: Controls */
    .header-right { display: flex; justify-content: flex-end; align-items: center; gap: 8px; }

    /* Refresh Buttons */
    .refresh-ctrl { display: flex; background: #f1f5f9; padding: 2px; border-radius: var(--radius-pill); }
    .refresh-btn { 
      border: none; background: transparent; padding: 4px 8px; 
      font-size: 11px; font-weight: 600; color: var(--text-sub); 
      border-radius: var(--radius-pill); cursor: pointer; transition: 0.2s;
    }
    .refresh-btn.active { background: #fff; color: var(--c-brand); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

    /* Logout Button (Solid Dark Gray) */
    .btn-logout {
      background: var(--c-dark); color: #fff; border: none; padding: 6px 12px;
      border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer;
    }
    .btn-logout:active { opacity: 0.9; }

    /* Level 1 Navigation (Big Pills) */
    .nav-tabs-wrapper {
      grid-column: 1 / -1; /* Full width row */
      display: flex; gap: 10px; margin-top: 12px; justify-content: center;
    }
    .nav-tab {
      flex: 1; padding: 10px 0; border: none; border-radius: var(--radius-pill);
      font-size: 16px; font-weight: 800; cursor: pointer; transition: 0.2s;
      text-align: center; white-space: nowrap;
    }
    /* Inactive: White bg, Blue border/text */
    .nav-tab { background: #fff; color: var(--c-brand); border: 1px solid var(--c-brand); }
    /* Active: Blue bg, White text */
    .nav-tab.active { background: var(--c-brand); color: #fff; border-color: var(--c-brand); box-shadow: 0 2px 6px rgba(31, 111, 229, 0.3); }

    /* =========================================
       3. Tab 1: Overall Info (ÁúãÊùø)
       ========================================= */
    /* Level 2 Filters */
    .dash-filters {
      display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 16px;
      -webkit-overflow-scrolling: touch;
    }
    .filter-btn {
      padding: 8px 16px; border-radius: var(--radius-pill); border: 1px solid transparent;
      font-size: 14px; font-weight: 700; white-space: nowrap; cursor: pointer;
      background: #fff; color: var(--text-sub); border-color: var(--border);
      transition: 0.2s;
    }
    /* Active State handled by JS inline styles for themes */
    
    .dash-section { margin-bottom: 24px; animation: fadeIn 0.3s; }
    .dash-title { 
      font-size: 16px; font-weight: 800; margin-bottom: 12px; 
      padding-left: 10px; border-left: 5px solid var(--c-brand); 
      display: flex; justify-content: space-between; align-items: center; color: var(--text-main);
    }
    
    /* Stat Cards */
    .stat-card {
      background: var(--bg-surface); border-radius: var(--radius-lg);
      padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
    }
    .step-header { font-size: 15px; font-weight: 700; margin-bottom: 10px; color: var(--text-main); }
    .stat-row { display: flex; gap: 12px; }
    .stat-box {
      flex: 1; text-align: center; background: #f8fafc;
      border-radius: var(--radius-md); padding: 12px 8px; cursor: pointer;
      border: 1px solid transparent;
    }
    .stat-box:active { background: #e2e8f0; }
    .stat-num { font-size: 28px; font-weight: 800; line-height: 1.1; }
    .stat-lbl { font-size: 12px; color: var(--text-sub); margin-top: 4px; font-weight: 600; }
    .num-done { color: var(--c-brand); }
    .num-todo { color: var(--c-danger); }

    /* Assign Block */
    .assign-block {
      background: #fff7ed; border: 2px dashed var(--c-orange);
      border-radius: var(--radius-lg); padding: 16px; margin-bottom: 16px;
    }
    .assign-title { font-size: 14px; font-weight: 800; color: #c2410c; margin-bottom: 8px; }
    .form-select {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1;
      background: #fff; font-size: 15px; margin-bottom: 8px; font-weight: 500;
    }
    .btn-assign {
      width: 100%; padding: 10px; background: var(--c-orange); color: white;
      border: none; border-radius: 8px; font-weight: 700; font-size: 15px; cursor: pointer;
    }

    /* Location Scroll (Peeking Effect) */
    .loc-container {
      display: flex; gap: 10px; padding-bottom: 8px; 
      overflow-x: auto; scroll-snap-type: x mandatory;
    }
    .loc-card {
      /* Mobile: 42% width ensures ~2.2 cards are visible (Peeking) */
      flex: 0 0 42%; 
      min-width: 120px; 
      background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 12px; text-align: center; 
      scroll-snap-align: start; cursor: pointer;
    }
    /* Desktop: 3 Columns Grid */
    @media (min-width: 768px) {
      .loc-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; overflow-x: visible; }
      .loc-card { flex: unset; min-width: auto; }
    }
    .loc-name { font-size: 13px; font-weight: 600; color: var(--text-sub); margin-bottom: 4px; }
    .loc-val { font-size: 24px; font-weight: 800; color: var(--c-brand); }

    /* Summary Table */
    .summary-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 8px; }
    .summary-table th, .summary-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; }
    .summary-table th { color: var(--text-sub); font-weight: 600; font-size: 13px; }
    .summary-table tr:last-child td { border-bottom: none; }
    .summary-table td { color: var(--text-main); font-weight: 500; }

    /* =========================================
       4. Tab 2: Operation (ÁôªÈåÑËàá‰øÆÊîπ)
       ========================================= */
    .op-toolbar { 
      display: flex; gap: 8px; margin-bottom: 16px; align-items: center; 
      background: #fff; padding: 10px; border-radius: var(--radius-md); box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .op-select { flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px; font-weight: 500; }
    .btn-add { 
      padding: 8px 12px; background: #fff; border: 1px solid var(--c-brand); 
      color: var(--c-brand); border-radius: 6px; font-weight: 700; cursor: pointer; white-space: nowrap;
    }

    /* List Card - Typography Update */
    .veh-card {
      background: var(--bg-surface); border-radius: var(--radius-md);
      padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      cursor: pointer; transition: 0.2s;
      display: flex; justify-content: space-between; align-items: center;
      min-height: 60px;
    }
    .veh-card:active { transform: scale(0.98); background-color: #f1f5f9; }

    .veh-left { display: flex; align-items: center; gap: 12px; }
    .txt-car { font-size: 20px; font-weight: 800; color: #000; } /* Big Black */
    .txt-area { font-size: 16px; font-weight: 500; color: var(--text-sub); } /* Medium Gray */
    .veh-status { font-size: 16px; font-weight: 700; color: var(--c-brand); text-align: right; white-space: nowrap; }

    .filter-bar {
      background: #eff6ff; color: var(--c-brand); padding: 8px 12px;
      border-radius: 8px; margin-bottom: 12px; font-size: 14px; display: flex;
      justify-content: space-between; align-items: center; border: 1px solid #bfdbfe;
    }
    .filter-clear { text-decoration: underline; cursor: pointer; font-weight: 700; }

    /* =========================================
       5. Bottom Sheet & Buttons
       ========================================= */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: var(--z-overlay); backdrop-filter: blur(2px); }
    .bottom-sheet {
      position: fixed; bottom: 0; left: 50%; right: auto; 
      width: 100%; max-width: var(--app-max-width);
      transform: translate(-50%, 100%); 
      background: #fff; border-radius: 20px 20px 0 0; padding: 24px; 
      transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: var(--z-bottom); max-height: 85vh; overflow-y: auto; 
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15); box-sizing: border-box;
    }
    .bottom-sheet.show { transform: translate(-50%, 0) !important; }

    .sheet-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .sheet-title { font-size: 22px; font-weight: 800; color: #000; }
    
    .action-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
    .action-label { font-size: 16px; font-weight: 600; color: var(--text-main); }
    
    /* Time & Status Colors */
    .action-time { font-family: monospace; font-size: 16px; font-weight: 700; color: var(--c-brand); margin-right: 12px; }
    .action-skip { font-size: 15px; color: var(--c-brand); font-weight: 700; margin-right: 12px; } /* Blue for skip */

    /* Dynamic Section */
    .dynamic-sep { border-top: 4px solid #f1f5f9; margin: 16px -24px 16px -24px; }
    .dynamic-title { font-size: 18px; font-weight: 800; margin-bottom: 12px; color: var(--text-main); padding-top: 8px; }

    .btn-group { display: flex; gap: 8px; }
    
    /* Unified Button Styles: Solid Small Rounded */
    .btn-solid { 
      padding: 8px 14px; border-radius: 8px; border: none; 
      font-size: 14px; font-weight: 700; color: white; cursor: pointer; min-width: 64px; 
      transition: opacity 0.2s;
    }
    .btn-solid:active { opacity: 0.8; }
    
    .btn-do    { background: var(--c-brand); }   /* Stamp - Blue */
    .btn-skip  { background: var(--c-neutral); } /* Skip - Gray Solid */
    .btn-mod   { background-color: var(--c-success); } /* Modify - Green */
    .btn-del   { background-color: var(--c-danger); }  /* Delete - Red */
    
    .sheet-select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 15px; font-weight: 500; }

    /* Loading & Login */
    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--c-brand); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loginView { display: flex; height: 100vh; flex-direction: column; align-items: center; justify-content: center; background: #fff; }
    .hidden { display: none !important; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<div id="loginView">
  <h2 style="color: var(--c-brand); margin-bottom: 24px;">2026 ËªäÊµÅÈÄÄÂ†¥‰ΩúÊ•≠</h2>
  <div id="g_id_onload"
       data-client_id="368914333961-tr57ogs6ig2cgfqqi5j5ml6h2ic67cd1.apps.googleusercontent.com" 
       data-callback="handleCredentialResponse"
       data-auto_select="true">
  </div>
  <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"></div>
</div>

<div id="appView" class="hidden">
  <header class="app-header">
    <div class="app-title">ËªäÊµÅ‰∫∫ÊµÅÈÄÄÂ†¥</div>
    <div class="header-clock" id="headerClock">--:--:--</div>
    <div class="header-right">
      <div class="refresh-ctrl" id="refreshCtrl"></div>
      <button class="btn-logout" onclick="logout()">ÁôªÂá∫</button>
    </div>
    <div class="nav-tabs-wrapper">
        <button class="nav-tab active" onclick="switchTab('dash')">Êï¥È´îÊÉÖÂ†±</button>
        <button class="nav-tab" onclick="switchTab('op')">ÁôªÈåÑËàá‰øÆÊîπ</button>
    </div>
  </header>

  <div class="container">
    <div id="tabDash" class="dash-section">
      <div class="dash-filters" id="dashFilters"></div>
      <div id="dashContent"></div>
    </div>

    <div id="tabOp" class="hidden">
      <div class="op-toolbar">
        <select id="sheetSelector" class="op-select" onchange="onSheetChange()"></select>
        <button id="btnAdd" class="btn-add hidden" onclick="promptAddColumn()">+ Á´ôÈªû</button>
      </div>
      <div id="filterMsg" class="filter-bar hidden">
        <span id="filterText"></span>
        <span class="filter-clear" onclick="clearFilter()">È°ØÁ§∫ÂÖ®ÈÉ®</span>
      </div>
      <div id="listContainer"></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-head">
    <div class="sheet-title" id="sheetTitle">ËªäËºõË≥áË®ä</div>
    <div style="font-size:24px; color:#999; cursor:pointer;" onclick="closeSheet()">‚úï</div>
  </div>
  <div id="sheetBody"></div>
</div>

<div id="loading"><div class="spinner"></div></div>

<script>
  // ================= CONFIG =================
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwzLPpv2wBq9D2Ao4W4KrRoEX3LPvJgrpxa5IUBGG2YPSSB0fQ4Hnk2dbqOpXLUJjIq4A/exec'; 
  
  const SHEET_CONFIGS = [
    { 
      key:'Âú∞ÂçÄÂ∞àËªäÈÄÄÂ†¥ÔºàÈÅäË¶ΩËªäÂπ≥Âè∞Ôºâ', color:'#059669',
      steps: ['ËªäÈï∑ÈÄöÁü•Ë°åÊùéÂà∞ÈΩä','Call Ëªä‰∏äË°åÊùé','ËªäÂ∑≤‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','ËªäÂâçÂæÄÊéíËªäÈöä','ËªäÊö´ÂÅú‰ΩçÁΩÆ','ÈÄÄÂ†¥‰∫∫Âì°Â∑≤Âà∞ÈΩä','Â∑≤ Call Ëªä‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','‰∫∫Â∑≤ÂâçÂæÄÂπ≥Âè∞Êê≠Ëªä','ËªäÁ¨¨‰∫åÊ¨°‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','ËªäÂ∑≤Èõ¢ÈñãÈÅäË¶ΩËªäÂπ≥Âè∞'],
      parkingField: 'ËªäÊö´ÂÅú‰ΩçÁΩÆ'
    },
    { 
      key:'Âú∞ÂçÄÂ∞àËªäÈÄÄÂ†¥ÔºàÁ¶™Â†ÇÂπ≥Âè∞Ôºâ', color:'#d97706',
      steps: ['ËªäÈï∑ÈÄöÁü•Ë°åÊùéÂà∞ÈΩä','Call Ëªä‰∏äË°åÊùé','ËªäÂ∑≤‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','Èõ¢ÈñãÈÅäË¶ΩËªäÂπ≥Âè∞','ÈÄöÈÅéÈÅäË¶ΩËªäÂπ≥Âè∞ÂâçÂæÄÊéíËªäÈöä','ËªäÂÅúÈù†‰ΩçÁΩÆ','‰∫∫Â∑≤ÂâçÂæÄÁ¶™Â†ÇÂπ≥Âè∞Êê≠Ëªä','ËªäÂ∑≤Èõ¢ÈñãÁ¶™Â†ÇÂπ≥Âè∞'],
      parkingField: 'ËªäÂÅúÈù†‰ΩçÁΩÆ'
    },
    { 
      key:'Ê∞¥Èô∏Â∞àËªäÈÄÄÂ†¥', color:'#7c3aed',
      steps: ['Á¢∫Ë™çËªäÂ∑≤ÊäµÈÅîÂúíÂçÄ','ËªäÊö´ÂÅú‰ΩçÁΩÆ','ÈÄÄÂ†¥‰∫∫Âì°Â∑≤Âà∞ÈΩä','Â∑≤ Call Ëªä‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','ËªäÂ∑≤‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','‰∫∫ÂæûËªäÂ∫´ÂâçÂæÄÂπ≥Âè∞Êê≠Ëªä','ËªäÂ∑≤Èõ¢ÈñãÈÅäË¶ΩËªäÂπ≥Âè∞'],
      parkingField: 'ËªäÊö´ÂÅú‰ΩçÁΩÆ'
    },
    { 
      key:'288Ê≥ïÈùíÈÄÄÂ†¥', color:'#db2777',
      steps: ['ÈÄÄÂ†¥‰∫∫Âì°Â∑≤Âà∞ÈΩä','ËªäÂ∑≤‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','ËªäÂ∑≤Èõ¢ÈñãÈÅäË¶ΩËªäÂπ≥Âè∞']
    }
  ];

  const STOP_OPTIONS = ['üÖøÔ∏è Á¶™Â†ÇÂπ≥Âè∞','üÖøÔ∏è Ê≥ïÂøÉÂåóË∑Ø','üÖøÔ∏è Ê≥ïÂøÉÂçóË∑ØÔºàË•øÔºâ','üÖøÔ∏è Ê≥ïÂøÉÂçóË∑ØÔºàÊù±Ôºâ','üÖøÔ∏è Ê≥ïÂ§ßË∑Ø','üÖøÔ∏è ÈõôÁí∞Ë∑ØËá≥Ê≥ïÂ§ß‰∏ÄÊ©ã'];
  const REFRESH_OPTIONS = [{ label:'5ÂàÜ', ms:300000 }, { label:'2ÂàÜ', ms:120000 }, { label:'60Áßí', ms:60000 }, { label:'30Áßí', ms:30000 }];

  let currentUser = null;
  let allData = {};
  let currentSheetName = SHEET_CONFIGS[0].key;
  let currentDashFilter = 'ALL'; // 'ALL' or sheet key
  let activeFilter = null;
  let refreshTimer = null;
  let refreshMs = 60000;

  function handleCredentialResponse(response) {
    const payload = JSON.parse(decodeURIComponent(atob(response.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
    currentUser = { email: payload.email, token: response.credential };
    document.getElementById('loading').style.display = 'flex';
    callApi('verify').then(res => {
      if(res.ok) {
        currentUser.permission = res.permission;
        initApp();
      } else {
        alert(res.msg);
        document.getElementById('loading').style.display = 'none';
      }
    });
  }

  function initApp() {
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('appView').classList.remove('hidden');
    
    if(currentUser.permission === 'ADMIN' || currentUser.permission === 'LEADER') {
      document.getElementById('btnAdd').classList.remove('hidden');
    }

    const isMobile = window.innerWidth < 768;
    const isPowerUser = currentUser.permission === 'ADMIN';
    if(isPowerUser && !isMobile) refreshMs = 30000; 
    else if(isMobile) refreshMs = 60000; 
    else refreshMs = 120000; 
    
    renderRefreshCtrl();
    renderSheetSelector();
    renderDashFilters(); 
    loadAllData(true);
    startTimer();
    startClock();
  }

  function startClock() {
    setInterval(() => {
      const now = new Date();
      document.getElementById('headerClock').textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
    }, 1000);
  }

  async function loadAllData(force = false) {
    if(!force) document.getElementById('loading').style.display = 'none';
    const res = await callApi('getAllData');
    if(res.ok) {
      allData = res.allSheets;
      renderDashboard();
      if(!document.getElementById('tabOp').classList.contains('hidden')){
         renderList(); 
      }
    }
    document.getElementById('loading').style.display = 'none';
  }

  async function callApi(action, data = {}) {
    try {
      const res = await fetch(SCRIPT_URL, { 
        method: 'POST', 
        body: JSON.stringify({ action, token: currentUser?.token, ...data }) 
      });
      return await res.json();
    } catch(e) { return { ok: false, msg: 'ÈÄ£Á∑öÈåØË™§' }; }
  }

  // ================= UI: DASHBOARD =================
  function renderDashFilters() {
    const box = document.getElementById('dashFilters');
    box.innerHTML = '';
    
    // ALL Button (Dark Gray)
    const allBtn = document.createElement('button');
    const isAllActive = currentDashFilter === 'ALL';
    allBtn.className = `filter-btn`;
    if(isAllActive) {
        allBtn.style.background = '#334155';
        allBtn.style.color = '#fff';
        allBtn.style.borderColor = '#334155';
    }
    allBtn.textContent = 'ÂÖ®ÈÉ®ÊÉÖÂ†±';
    allBtn.onclick = () => { currentDashFilter = 'ALL'; renderDashFilters(); renderDashboard(); };
    box.appendChild(allBtn);

    // Sheet Buttons (Colored)
    SHEET_CONFIGS.forEach(cfg => {
      const btn = document.createElement('button');
      const isActive = currentDashFilter === cfg.key;
      btn.className = `filter-btn`;
      if(isActive) {
        btn.style.backgroundColor = cfg.color;
        btn.style.borderColor = cfg.color;
        btn.style.color = '#fff';
      } else {
        btn.style.color = cfg.color;
        btn.style.borderColor = cfg.color;
      }
      btn.textContent = cfg.key;
      btn.onclick = () => { currentDashFilter = cfg.key; renderDashFilters(); renderDashboard(); };
      box.appendChild(btn);
    });
  }

  function renderDashboard() {
    const container = document.getElementById('dashContent');
    container.innerHTML = '';

    SHEET_CONFIGS.forEach(cfg => {
      if(currentDashFilter !== 'ALL' && currentDashFilter !== cfg.key) return;

      const data = allData[cfg.key];
      if(!data || !data.headers) return; 

      const wrapper = document.createElement('div');
      wrapper.className = 'dash-section';
      wrapper.innerHTML = `<div class="dash-title" style="color:${cfg.color}; border-color:${cfg.color}">${cfg.key}</div>`;

      const steps = cfg.steps;
      const parkingStep = cfg.parkingField;
      const parkingIdx = steps.indexOf(parkingStep);
      
      const inbound = parkingIdx >= 0 ? steps.slice(0, parkingIdx) : steps;
      const outbound = parkingIdx >= 0 ? steps.slice(parkingIdx + 1) : [];

      inbound.forEach(step => wrapper.appendChild(createStatCard(step, data, cfg)));

      // Assign Block
      if(parkingStep && currentUser.permission === 'ADMIN') {
        const assignBlock = createAssignBlock(data, cfg, parkingStep);
        if(assignBlock) wrapper.appendChild(assignBlock);
      }

      // Location Stats
      if(parkingStep) {
        const locContainer = document.createElement('div');
        locContainer.className = 'loc-container';
        const colIdx = data.headers.findIndex(h => h.name === parkingStep);
        const counts = {};
        STOP_OPTIONS.forEach(s => counts[s] = 0);
        data.rows.forEach(r => {
          const val = (r[colIdx] || '').trim();
          if(counts[val] !== undefined) counts[val]++;
        });
        STOP_OPTIONS.forEach(loc => {
          const card = document.createElement('div');
          card.className = 'loc-card';
          card.innerHTML = `<div class="loc-name">${loc}</div><div class="loc-val">${counts[loc]}</div>`;
          locContainer.appendChild(card);
        });
        wrapper.appendChild(locContainer);
      }

      // Outbound
      if(outbound.length > 0) {
        const outTitle = document.createElement('div');
        outTitle.className = 'step-header';
        outTitle.style.marginTop = '16px';
        outTitle.textContent = 'ÈÄÄÂ†¥Á®ãÂ∫è';
        wrapper.appendChild(outTitle);
        outbound.forEach(step => wrapper.appendChild(createStatCard(step, data, cfg)));
      }

      // Summary Table
      const dynamicHeaders = data.headers.filter(h => h.isDynamic);
      if(dynamicHeaders.length > 0) {
        const summaryBox = createSummaryTable(data, dynamicHeaders, cfg);
        if(summaryBox) wrapper.appendChild(summaryBox);
      }

      container.appendChild(wrapper);
    });
  }

  function createSummaryTable(data, dynamicHeaders, cfg) {
    const rows = [];
    const carIdx = data.headers.findIndex(h => h.name === 'ËªäËôü');
    const areaIdx = data.headers.findIndex(h => h.name.includes('ÂçÄÂüü') || h.name.includes('Á∑®Ëôü'));

    data.rows.forEach(r => {
      dynamicHeaders.forEach(dh => {
        const colIdx = data.headers.indexOf(dh);
        const val = (r[colIdx] || '').trim();
        if(val && val !== 'Skip' && val !== '-') {
          rows.push({ car: r[carIdx], area: r[areaIdx], station: dh.name, time: val });
        }
      });
    });

    if(rows.length === 0) return null;

    const box = document.createElement('div');
    box.className = 'stat-card'; 
    box.style.padding = '12px';
    
    let html = `<div class="dash-title" style="color:${cfg.color}; border-color:${cfg.color}; margin-top:0;">Êñ∞Â¢ûÁ´ôÈªûÁ¥ÄÈåÑ</div>
    <table class="summary-table">
      <tr><th>ËªäËôü</th><th>ÂçÄÂüü</th><th>Âú∞Èªû</th><th>ÊôÇÈñì</th></tr>`;
    rows.forEach(r => {
      html += `<tr><td>${r.car}</td><td>${r.area}</td><td>${r.station}</td><td>${r.time}</td></tr>`;
    });
    html += '</table>';
    box.innerHTML = html;
    return box;
  }

  function createStatCard(step, data, cfg) {
    const colIdx = data.headers.findIndex(h => h.name === step);
    let done = 0, todo = 0;
    data.rows.forEach(row => {
      const val = (row[colIdx] || '').trim();
      (val && val !== 'Skip' && val !== '-') ? done++ : todo++;
    });

    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `
      <div class="step-header">${step}</div>
      <div class="stat-row">
        <div class="stat-box" onclick="goToFilter('${cfg.key}', '${step}', 'done')">
          <div class="stat-num num-done">${done}</div>
          <div class="stat-lbl">ÂÆåÊàê</div>
        </div>
        <div class="stat-box" onclick="goToFilter('${cfg.key}', '${step}', 'todo')">
          <div class="stat-num num-todo" style="${todo===0?'color:#ccc':''}">${todo}</div>
          <div class="stat-lbl">Êú™ÂÆåÊàê</div>
        </div>
      </div>`;
    return card;
  }

  function createAssignBlock(data, cfg, parkingStep) {
    const colIdx = data.headers.findIndex(h => h.name === parkingStep);
    const candidates = data.rows.filter(r => {
      const val = (r[colIdx] || '').trim();
      return !val || val === '-';
    });
    if(candidates.length === 0) return null;

    const div = document.createElement('div');
    div.className = 'assign-block';
    const carIdx = data.headers.findIndex(h => h.name === 'ËªäËôü');
    const areaIdx = data.headers.findIndex(h => h.name.includes('ÂçÄÂüü') || h.name.includes('Á∑®Ëôü'));
    
    let carOpts = `<option value="">Ë´ãÈÅ∏ÊìáËªäËºõ...</option>`;
    candidates.forEach((r) => carOpts += `<option value="${r[carIdx]}">${r[areaIdx]} ${r[carIdx]}</option>`);
    let locOpts = `<option value="">Ë´ãÈÅ∏Êìá‰ΩçÁΩÆ...</option>` + STOP_OPTIONS.map(s => `<option value="${s}">${s}</option>`).join('');

    div.innerHTML = `
      <div class="assign-title">ËªäÊö´ÂÅú‰ΩçÁΩÆÁôªÈåÑ</div>
      <select class="form-select" id="assignLoc_${cfg.key}">${locOpts}</select>
      <select class="form-select" id="assignCar_${cfg.key}">${carOpts}</select>
      <button class="btn-assign" onclick="doQuickAssign('${cfg.key}', '${parkingStep}')">Á¢∫ÂÆö</button>
    `;
    return div;
  }

  // ================= UI: LIST =================
  function renderList() {
    const data = allData[currentSheetName];
    if(!data || !data.headers) return;

    const container = document.getElementById('listContainer');
    container.innerHTML = '';
    const header = data.headers;
    const carIdx = header.findIndex(h => h.name === 'ËªäËôü');
    let areaIdx = header.findIndex(h => h.name === 'ÂçÄÂüüËªäÊ¨°Á∑®Ëôü');
    if (areaIdx === -1) areaIdx = header.findIndex(h => h.name.includes('ÂçÄÂüü'));

    let rows = data.rows;
    if(activeFilter) {
      document.getElementById('filterMsg').classList.remove('hidden');
      document.getElementById('filterText').textContent = `ÁØ©ÈÅ∏: ${activeFilter.step} (${activeFilter.status === 'done' ? 'ÂÆåÊàê' : 'Êú™ÂÆåÊàê'})`;
      const stepIdx = header.findIndex(h => h.name === activeFilter.step);
      rows = rows.filter(r => {
        const val = (r[stepIdx] || '').trim();
        const isDone = (val && val !== '-' && val !== 'Skip');
        return activeFilter.status === 'done' ? isDone : !isDone;
      });
    } else {
      document.getElementById('filterMsg').classList.add('hidden');
    }

    if(rows.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ÁÑ°Á¨¶ÂêàË≥áÊñô</div>';
      return;
    }

    rows.forEach(row => {
      const card = document.createElement('div');
      card.className = 'veh-card';
      
      let statusText = 'Ê∫ñÂÇô‰∏≠';
      let statusColorClass = 'color: #64748b'; // default gray
      
      // Determine latest status
      const parkingStep = SHEET_CONFIGS.find(c=>c.key===currentSheetName).parkingField;
      if(parkingStep) {
        const pIdx = header.findIndex(h => h.name === parkingStep);
        const pVal = (row[pIdx] || '').trim();
        if(pVal) { statusText = pVal; statusColorClass = 'color: var(--c-brand)'; }
      }
      
      // Basic check for skipping (simplified)
      // Ideally we check the LAST non-empty step.
      
      card.innerHTML = `
        <div class="veh-left">
          <div class="txt-car">${row[carIdx] || ''}</div>
          <div class="txt-area">${row[areaIdx] || ''}</div>
        </div>
        <div class="veh-status" style="${statusColorClass}">${statusText}</div>
      `;
      card.onclick = () => openBottomSheet(row, header, carIdx);
      container.appendChild(card);
    });
  }

  function openBottomSheet(row, header, carIdx) {
    const title = document.getElementById('sheetTitle');
    title.textContent = row[carIdx];
    const body = document.getElementById('sheetBody');
    body.innerHTML = '';

    const cfg = SHEET_CONFIGS.find(s => s.key === currentSheetName);
    const isViewer = currentUser.permission === 'VIEWER';

    let allSteps = [...cfg.steps];
    const dynamicHeaders = header.filter(h => h.isDynamic).map(h => h.name);
    const standardCount = allSteps.length;
    allSteps = allSteps.concat(dynamicHeaders);

    allSteps.forEach((step, index) => {
      // Dynamic Section Divider
      if(index === standardCount) {
        const sep = document.createElement('div'); sep.className = 'dynamic-sep';
        const head = document.createElement('div'); head.className = 'dynamic-title'; head.textContent = 'Êñ∞Â¢ûÁ´ôÈªû';
        body.appendChild(sep);
        body.appendChild(head);
      }

      const hIdx = header.findIndex(h => h.name === step);
      const val = (row[hIdx] || '').trim();
      
      const rowDiv = document.createElement('div');
      rowDiv.className = 'action-row';
      const left = document.createElement('div');
      left.innerHTML = `<div class="action-label">${step}</div>`;
      rowDiv.appendChild(left);

      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.alignItems = 'center';
      
      if(step === cfg.parkingField) {
        if(!isViewer) {
          const sel = document.createElement('select');
          sel.className = 'sheet-select';
          sel.innerHTML = `<option value="">---- Ê∏ÖÈô§ ----</option>` + STOP_OPTIONS.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('');
          sel.onchange = () => doAction(row[carIdx], step, sel.value, true);
          right.appendChild(sel);
        } else {
          right.innerHTML = `<span class="action-time" style="color:#000">${val || '-'}</span>`;
        }
      } 
      else {
        if(val && val !== 'Skip' && val !== '-') {
          // Completed
          right.innerHTML = `<span class="action-time">${val}</span>`;
          if(!isViewer) {
             const div = document.createElement('div'); div.className = 'btn-group';
             div.innerHTML = `
               <button class="btn-solid btn-mod" onclick="modifyTime('${row[carIdx]}', '${step}', '${val}')">‰øÆÊîπ</button>
               <button class="btn-solid btn-del" onclick="doAction('${row[carIdx]}', '${step}', '')">Âà™Èô§</button>
             `;
             right.appendChild(div);
          }
        } else if(val === 'Skip' || val === '-') {
          // Skipped (Blue text)
          right.innerHTML = `<span class="action-skip">Â∑≤Áï•ÈÅé</span>`;
          if(!isViewer) {
             const div = document.createElement('div'); div.className = 'btn-group';
             div.innerHTML = `
               <button class="btn-solid btn-mod" onclick="modifyTime('${row[carIdx]}', '${step}', '')">‰øÆÊîπ</button>
               <button class="btn-solid btn-del" onclick="doAction('${row[carIdx]}', '${step}', '')">Âà™Èô§</button>
             `;
             right.appendChild(div);
          }
        } else {
          // Empty
          if(!isViewer) {
            const div = document.createElement('div'); div.className = 'btn-group';
            div.innerHTML = `
              <button class="btn-solid btn-do" onclick="doAction('${row[carIdx]}', '${step}', null)">ÊâìÂç°</button>
              <button class="btn-solid btn-skip" onclick="doAction('${row[carIdx]}', '${step}', '-')">Áï•ÈÅé</button>
            `;
            right.appendChild(div);
          } else {
            right.innerHTML = '<span style="color:#ccc">Êú™ÂÆåÊàê</span>';
          }
        }
      }
      rowDiv.appendChild(right);
      body.appendChild(rowDiv);
    });

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('bottomSheet').classList.add('show');
  }

  // ================= ACTIONS =================
  async function doAction(carNo, colName, value, isUpdate = false) {
    document.getElementById('loading').style.display = 'flex';
    closeSheet();
    const action = isUpdate ? 'update' : 'stamp';
    await callApi(action, { sheetName: currentSheetName, carNo, colName, value });
    await loadAllData(true);
  }

  function modifyTime(carNo, step, oldVal) {
    const newVal = prompt('‰øÆÊîπÊôÇÈñì:', oldVal || '');
    if(newVal !== null) doAction(carNo, step, newVal, true);
  }

  async function doQuickAssign(sheetKey, colName) {
    const loc = document.getElementById(`assignLoc_${sheetKey}`).value;
    const carNo = document.getElementById(`assignCar_${sheetKey}`).value;
    if(!loc || !carNo) return alert('Ë´ãÈÅ∏Êìá‰ΩçÁΩÆËàáËªäËºõ');
    
    const originalSheet = currentSheetName;
    currentSheetName = sheetKey; 
    await doAction(carNo, colName, loc, true);
    currentSheetName = originalSheet;
  }

  function promptAddColumn() {
    const name = prompt("Ë´ãËº∏ÂÖ•Êñ∞Á´ôÈªûÂêçÁ®±:");
    if(name) {
      document.getElementById('loading').style.display = 'flex';
      callApi('addColumn', { sheetName: currentSheetName, colName: name }).then(() => loadAllData(true));
    }
  }

  function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    // Identify active tab by click target or manual logic
    // Using simple approach: if tab='dash', activate first button
    const btns = document.querySelectorAll('.nav-tab');
    if(tab === 'dash') btns[0].classList.add('active');
    else btns[1].classList.add('active');
    
    if(tab === 'dash') {
      document.getElementById('tabDash').classList.remove('hidden');
      document.getElementById('tabOp').classList.add('hidden');
    } else {
      document.getElementById('tabDash').classList.add('hidden');
      document.getElementById('tabOp').classList.remove('hidden');
      renderList(); 
    }
  }

  function goToFilter(sheetKey, step, status) {
    currentSheetName = sheetKey;
    activeFilter = { step, status };
    document.getElementById('sheetSelector').value = sheetKey;
    switchTab('op');
  }

  function clearFilter() { activeFilter = null; renderList(); }
  function onSheetChange() { currentSheetName = document.getElementById('sheetSelector').value; activeFilter = null; renderList(); }
  
  function closeSheet() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('bottomSheet').classList.remove('show');
  }

  function renderSheetSelector() {
    const sel = document.getElementById('sheetSelector');
    sel.innerHTML = SHEET_CONFIGS.map(s => `<option value="${s.key}">${s.key}</option>`).join('');
  }

  function renderRefreshCtrl() {
    const box = document.getElementById('refreshCtrl');
    box.innerHTML = REFRESH_OPTIONS.map(opt => 
      `<button class="refresh-btn ${refreshMs===opt.ms?'active':''}" onclick="setRefresh(${opt.ms})">${opt.label}</button>`
    ).join('');
  }

  function setRefresh(ms) { refreshMs = ms; renderRefreshCtrl(); startTimer(); }
  function startTimer() { if(refreshTimer) clearInterval(refreshTimer); refreshTimer = setInterval(() => loadAllData(false), refreshMs); }
  function logout() { localStorage.removeItem('ddcc_user_token'); location.reload(); }
</script>
</body>
</html>
