<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026 ËªäÊµÅÈÄÄÂ†¥‰ΩúÊ•≠Á≥ªÁµ±</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* =========================================
       1. Design Tokens & Colors
       ========================================= */
    :root {
      /* Brand Colors */
      --c-brand: #1f6fe5;       /* ‰∏ªËâ≤Ëóç */
      --c-brand-dark: #1e40af;  /* Ê∑±Ëóç */
      
      /* Functional Colors */
      --c-success: #22c55e;     /* ‰øÆÊîπ/Á∂† */
      --c-danger: #ef4444;      /* Âà™Èô§/Á¥Ö */
      --c-neutral: #64748b;     /* Áï•ÈÅé/ÁÅ∞ */
      --c-dark: #334155;        /* Á≥ªÁµ±/Ê∑±ÁÅ∞ */
      
      /* Backgrounds for Completed State */
      --bg-success-light: #ecfdf5; 
      --border-success: #10b981;
      --text-success: #047857;

      /* UI Bases */
      --bg-body: #e5e7eb;
      --bg-app: #f8fafc;
      --bg-surface: #ffffff;
      --border: #e2e8f0;
      
      /* Text */
      --text-main: #0f172a;
      --text-sub: #64748b;

      /* Metrics */
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-pill: 50px;
      --app-max-width: 800px; 
      
      /* Layers */
      --z-bottom: 1100;
      --z-overlay: 1000;
      --z-header: 500;
    }

    body { 
      margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      background: var(--bg-body); color: var(--text-main); 
      padding-bottom: 0; -webkit-tap-highlight-color: transparent;
    }

    /* App Shell */
    #appView {
      max-width: var(--app-max-width); margin: 0 auto;
      background-color: var(--bg-app); min-height: 100vh;
      box-shadow: 0 0 30px rgba(0,0,0,0.1); padding-bottom: 80px; 
    }

    .container { padding: 16px; }

    /* =========================================
       2. Header (Grid Layout)
       ========================================= */
    .app-header {
      background: var(--bg-surface); padding: 12px 16px;
      position: sticky; top: 0; z-index: var(--z-header);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center; gap: 8px;
    }

    .app-title { font-size: 1.1rem; font-weight: 800; color: var(--c-brand); white-space: nowrap; }

    .header-clock { 
      font-family: monospace; font-size: 1.1rem; font-weight: 800; 
      color: var(--text-main); white-space: nowrap; 
    }

    .header-right { display: flex; justify-content: flex-end; align-items: center; gap: 8px; }

    .refresh-ctrl { display: flex; background: #f1f5f9; padding: 2px; border-radius: var(--radius-pill); }
    .refresh-btn { 
      border: none; background: transparent; padding: 4px 8px; 
      font-size: 11px; font-weight: 600; color: var(--text-sub); 
      border-radius: var(--radius-pill); cursor: pointer; transition: 0.2s;
    }
    .refresh-btn.active { background: #fff; color: var(--c-brand); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

    .btn-logout {
      background: var(--c-dark); color: #fff; border: none; padding: 6px 12px;
      border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer;
    }

    /* Level 1 Navigation (Big Pills) */
    .nav-tabs-wrapper {
      grid-column: 1 / -1;
      display: flex; gap: 10px; margin-top: 12px; justify-content: center;
    }
    .nav-tab {
      flex: 1; padding: 10px 0; border: none; border-radius: var(--radius-pill);
      font-size: 16px; font-weight: 800; cursor: pointer; transition: 0.2s;
      text-align: center; white-space: nowrap;
      background: #fff; color: var(--c-brand); border: 1px solid var(--c-brand);
    }
    .nav-tab.active { background: var(--c-brand); color: #fff; border-color: var(--c-brand); box-shadow: 0 2px 6px rgba(31, 111, 229, 0.3); }

    /* =========================================
       3. Tab 1: Overall Info (ÁúãÊùø)
       ========================================= */
    .dash-filters {
      display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 16px;
      -webkit-overflow-scrolling: touch;
    }
    .filter-btn {
      padding: 8px 16px; border-radius: var(--radius-pill); border: 1px solid transparent;
      font-size: 14px; font-weight: 700; white-space: nowrap; cursor: pointer;
      background: #fff; color: var(--text-sub); border-color: var(--border);
      transition: 0.2s;
    }
    
    .dash-section { margin-bottom: 24px; animation: fadeIn 0.3s; }
    .dash-title { 
      font-size: 16px; font-weight: 800; margin-bottom: 12px; 
      padding-left: 10px; border-left: 5px solid var(--c-brand); 
      display: flex; justify-content: space-between; align-items: center; color: var(--text-main);
    }
    
    .stat-card {
      background: var(--bg-surface); border-radius: var(--radius-lg);
      padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
    }
    .step-header { font-size: 15px; font-weight: 700; margin-bottom: 10px; color: var(--text-main); }
    .stat-row { display: flex; gap: 12px; }
    .stat-box {
      flex: 1; text-align: center; background: #f8fafc;
      border-radius: var(--radius-md); padding: 12px 8px; cursor: pointer;
      border: 1px solid transparent;
    }
    .stat-box:active { background: #e2e8f0; }
    .stat-num { font-size: 28px; font-weight: 800; line-height: 1.1; }
    .stat-lbl { font-size: 12px; color: var(--text-sub); margin-top: 4px; font-weight: 600; }
    .num-done { color: var(--c-brand); }
    .num-todo { color: var(--c-danger); }

    /* Location Cards (Peeking & Grid) */
    .loc-container {
      display: flex; gap: 10px; padding-bottom: 8px; 
      overflow-x: auto; scroll-snap-type: x mandatory;
    }
    .loc-card {
      flex: 0 0 42%; min-width: 120px; 
      background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 12px; text-align: center; 
      scroll-snap-align: start; cursor: pointer;
      transition: 0.2s;
    }
    .loc-card:active { transform: scale(0.98); background: #f1f5f9; }
    @media (min-width: 768px) {
      .loc-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; overflow-x: visible; }
      .loc-card { flex: unset; min-width: auto; }
    }
    .loc-name { font-size: 13px; font-weight: 600; color: var(--text-sub); margin-bottom: 4px; }
    .loc-val { font-size: 24px; font-weight: 800; color: var(--c-brand); }

    /* Summary Table */
    .summary-table { width: 100%; border-collapse: collapse; font-size: 14px; margin-top: 8px; }
    .summary-table th, .summary-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; }
    .summary-table th { color: var(--text-sub); font-weight: 600; font-size: 13px; }
    .summary-table tr:last-child td { border-bottom: none; }
    .summary-table td { color: var(--text-main); font-weight: 500; }

    /* =========================================
       4. Tab 2: Operation (ÁôªÈåÑËàá‰øÆÊîπ) - GRID LAYOUT
       ========================================= */
    .op-toolbar { 
      display: flex; gap: 8px; margin-bottom: 16px; align-items: center; 
      background: #fff; padding: 10px; border-radius: var(--radius-md); box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .op-select { flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 15px; font-weight: 500; }
    .btn-add { 
      padding: 8px 12px; background: #fff; border: 1px solid var(--c-brand); 
      color: var(--c-brand); border-radius: 6px; font-weight: 700; cursor: pointer; white-space: nowrap;
    }

    /* List Card - Grid */
    .veh-card {
      background: var(--bg-surface); border-radius: var(--radius-md);
      padding: 12px 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      cursor: pointer; transition: 0.2s; border: 1px solid transparent;
      
      /* Grid Layout: Car | Area | Status | Btn */
      display: grid;
      grid-template-columns: 22fr 22fr 46fr 40px; 
      align-items: center; gap: 8px;
      min-height: 60px;
    }
    .veh-card:active { transform: scale(0.98); }

    /* Text Styles */
    .txt-car { font-size: 18px; font-weight: 800; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .txt-area { font-size: 18px; font-weight: 800; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .veh-status { 
      font-size: 15px; font-weight: 700; color: var(--c-brand); 
      white-space: pre-line; /* Handle multi-line */
      line-height: 1.4;
      text-align: left; 
    }

    /* Expand Button (+) */
    .btn-expand {
      width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
      background: #f1f5f9; color: var(--c-brand); border-radius: 8px; 
      font-weight: 800; font-size: 20px; border: 1px solid #e2e8f0;
    }

    /* Completed State */
    .veh-card.completed {
      background-color: var(--bg-success-light);
      border-color: var(--border-success);
    }
    .veh-card.completed .veh-status { color: var(--text-success); }
    .veh-card.completed .btn-expand { background: var(--border-success); color: #fff; border-color: var(--border-success); content: "‚úì"; }

    .filter-bar {
      background: #eff6ff; color: var(--c-brand); padding: 8px 12px;
      border-radius: 8px; margin-bottom: 12px; font-size: 14px; display: flex;
      justify-content: space-between; align-items: center; border: 1px solid #bfdbfe;
    }
    .filter-clear { text-decoration: underline; cursor: pointer; font-weight: 700; }

    /* =========================================
       5. Bottom Sheet (Three Column Grid)
       ========================================= */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: var(--z-overlay); backdrop-filter: blur(2px); }
    .bottom-sheet {
      position: fixed; bottom: 0; left: 50%; right: auto; 
      width: 100%; max-width: var(--app-max-width);
      transform: translate(-50%, 100%); 
      background: #fff; border-radius: 20px 20px 0 0; padding: 24px; 
      transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: var(--z-bottom); max-height: 85vh; overflow-y: auto; 
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15); box-sizing: border-box;
    }
    .bottom-sheet.show { transform: translate(-50%, 0) !important; }

    .sheet-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .sheet-title { font-size: 22px; font-weight: 800; color: #000; }
    
    /* 3-Column Grid: Label | Time | Buttons */
    .action-row { 
      display: grid; 
      grid-template-columns: 140px 1fr auto; 
      align-items: center; 
      padding: 12px 0; 
      border-bottom: 1px dashed #eee; 
      gap: 8px;
    }
    
    .action-label { font-size: 16px; font-weight: 600; color: var(--text-main); text-align: left; }
    
    .action-mid { text-align: center; } /* Center column */
    .action-right { display: flex; justify-content: flex-end; } /* Right column */

    /* Time & Status Colors */
    .action-time { font-family: monospace; font-size: 16px; font-weight: 700; color: var(--c-brand); }
    .action-skip { font-size: 15px; color: var(--c-brand); font-weight: 700; }

    .dynamic-sep { border-top: 4px solid #f1f5f9; margin: 16px -24px 16px -24px; }
    .dynamic-title { font-size: 18px; font-weight: 800; margin-bottom: 12px; color: var(--text-main); padding-top: 8px; }

    .btn-group { display: flex; gap: 8px; }
    .btn-solid { 
      padding: 8px 14px; border-radius: 8px; border: none; 
      font-size: 14px; font-weight: 700; color: white; cursor: pointer; min-width: 64px; 
      transition: opacity 0.2s;
    }
    .btn-solid:active { opacity: 0.8; }
    
    .btn-do    { background: var(--c-brand); }
    .btn-skip  { background: var(--c-neutral); }
    .btn-mod   { background-color: var(--c-success); }
    .btn-del   { background-color: var(--c-danger); }
    
    .sheet-select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 15px; font-weight: 500; width: 100%; }
    
    /* Location Management List Styles */
    .loc-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
    .loc-list-txt { font-size: 16px; font-weight: 700; color: var(--text-main); }
    .btn-remove-loc { color: #fff; font-size: 13px; font-weight: 700; cursor: pointer; background: var(--c-danger); padding: 6px 12px; border-radius: 6px; border:none; }

    /* Loading & Login */
    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--c-brand); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loginView { display: flex; height: 100vh; flex-direction: column; align-items: center; justify-content: center; background: #fff; }
    .hidden { display: none !important; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<div id="loginView">
  <h2 style="color: var(--c-brand); margin-bottom: 24px;">2026 ËªäÊµÅÈÄÄÂ†¥‰ΩúÊ•≠</h2>
  <div id="g_id_onload"
       data-client_id="368914333961-tr57ogs6ig2cgfqqi5j5ml6h2ic67cd1.apps.googleusercontent.com" 
       data-callback="handleCredentialResponse"
       data-auto_select="true">
  </div>
  <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"></div>
</div>

<div id="appView" class="hidden">
  <header class="app-header">
    <div class="app-title">2026Ê∞¥Èô∏Ê≥ïÊúÉÈÄÄÂ†¥</div>
    <div class="header-clock" id="headerClock">--:--:--</div>
    <div class="header-right">
      <div class="refresh-ctrl" id="refreshCtrl"></div>
      <button class="btn-logout" onclick="logout()">ÁôªÂá∫</button>
    </div>
    <div class="nav-tabs-wrapper">
        <button class="nav-tab active" onclick="switchTab('dash')">Êï¥È´îÊÉÖÂ†±</button>
        <button class="nav-tab" onclick="switchTab('op')">ÁôªÈåÑËàá‰øÆÊîπ</button>
    </div>
  </header>

  <div class="container">
    <div id="tabDash" class="dash-section">
      <div class="dash-filters" id="dashFilters"></div>
      <div id="dashContent"></div>
    </div>

    <div id="tabOp" class="hidden">
      <div class="op-toolbar">
        <select id="sheetSelector" class="op-select" onchange="onSheetChange()"></select>
        <button id="btnAdd" class="btn-add hidden" onclick="promptAddColumn()">+ Á´ôÈªû</button>
      </div>
      <div id="filterMsg" class="filter-bar hidden">
        <span id="filterText"></span>
        <span class="filter-clear" onclick="clearFilter()">È°ØÁ§∫ÂÖ®ÈÉ®</span>
      </div>
      <div id="listContainer"></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-head">
    <div class="sheet-title" id="sheetTitle">ËªäËºõË≥áË®ä</div>
    <div style="font-size:24px; color:#999; cursor:pointer;" onclick="closeSheet()">‚úï</div>
  </div>
  <div id="sheetBody"></div>
</div>

<div id="loading"><div class="spinner"></div></div>

<script>
  // ================= CONFIG =================
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwzLPpv2wBq9D2Ao4W4KrRoEX3LPvJgrpxa5IUBGG2YPSSB0fQ4Hnk2dbqOpXLUJjIq4A/exec'; 
  
  const SHEET_CONFIGS = [
    { 
      key:'Âú∞ÂçÄÂ∞àËªäÈÄÄÂ†¥ÔºàÈÅäË¶ΩËªäÂπ≥Âè∞Ôºâ', color:'#059669',
      steps: ['ËªäÈï∑ÈÄöÁü•Ë°åÊùéÂà∞ÈΩä','Call Ëªä‰∏äË°åÊùé','ËªäÂ∑≤‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','ËªäÂâçÂæÄÊéíËªäÈöä','ËªäÊö´ÂÅú‰ΩçÁΩÆ','ÈÄÄÂ†¥‰∫∫Âì°Â∑≤Âà∞ÈΩä','Â∑≤ Call Ëªä‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','‰∫∫Â∑≤ÂâçÂæÄÂπ≥Âè∞Êê≠Ëªä','ËªäÁ¨¨‰∫åÊ¨°‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','ËªäÂ∑≤Èõ¢ÈñãÈÅäË¶ΩËªäÂπ≥Âè∞'],
      parkingField: 'ËªäÊö´ÂÅú‰ΩçÁΩÆ'
    },
    { 
      key:'Âú∞ÂçÄÂ∞àËªäÈÄÄÂ†¥ÔºàÁ¶™Â†ÇÂπ≥Âè∞Ôºâ', color:'#d97706',
      steps: ['ËªäÈï∑ÈÄöÁü•Ë°åÊùéÂà∞ÈΩä','Call Ëªä‰∏äË°åÊùé','ËªäÂ∑≤‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','Èõ¢ÈñãÈÅäË¶ΩËªäÂπ≥Âè∞','ÈÄöÈÅéÈÅäË¶ΩËªäÂπ≥Âè∞ÂâçÂæÄÊéíËªäÈöä','ËªäÂÅúÈù†‰ΩçÁΩÆ','‰∫∫Â∑≤ÂâçÂæÄÁ¶™Â†ÇÂπ≥Âè∞Êê≠Ëªä','ËªäÂ∑≤Èõ¢ÈñãÁ¶™Â†ÇÂπ≥Âè∞'],
      parkingField: 'ËªäÂÅúÈù†‰ΩçÁΩÆ'
    },
    { 
      key:'Ê∞¥Èô∏Â∞àËªäÈÄÄÂ†¥', color:'#7c3aed',
      steps: ['Á¢∫Ë™çËªäÂ∑≤ÊäµÈÅîÂúíÂçÄ','ËªäÊö´ÂÅú‰ΩçÁΩÆ','ÈÄÄÂ†¥‰∫∫Âì°Â∑≤Âà∞ÈΩä','Â∑≤ Call Ëªä‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','ËªäÂ∑≤‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','‰∫∫ÂæûËªäÂ∫´ÂâçÂæÄÂπ≥Âè∞Êê≠Ëªä','ËªäÂ∑≤Èõ¢ÈñãÈÅäË¶ΩËªäÂπ≥Âè∞'],
      parkingField: 'ËªäÊö´ÂÅú‰ΩçÁΩÆ'
    },
    { 
      key:'288Ê≥ïÈùíÈÄÄÂ†¥', color:'#db2777',
      steps: ['ÈÄÄÂ†¥‰∫∫Âì°Â∑≤Âà∞ÈΩä','ËªäÂ∑≤‰∏äÈÅäË¶ΩËªäÂπ≥Âè∞','ËªäÂ∑≤Èõ¢ÈñãÈÅäË¶ΩËªäÂπ≥Âè∞']
    }
  ];

  const STOP_OPTIONS = ['üÖøÔ∏è Á¶™Â†ÇÂπ≥Âè∞','üÖøÔ∏è Ê≥ïÂøÉÂåóË∑Ø','üÖøÔ∏è Ê≥ïÂøÉÂçóË∑ØÔºàË•øÔºâ','üÖøÔ∏è Ê≥ïÂøÉÂçóË∑ØÔºàÊù±Ôºâ','üÖøÔ∏è Ê≥ïÂ§ßË∑Ø','üÖøÔ∏è ÈõôÁí∞Ë∑ØËá≥Ê≥ïÂ§ß‰∏ÄÊ©ã'];
  const REFRESH_OPTIONS = [{ label:'5ÂàÜ', ms:300000 }, { label:'2ÂàÜ', ms:120000 }, { label:'60Áßí', ms:60000 }, { label:'30Áßí', ms:30000 }];

  let currentUser = null;
  let allData = {};
  let currentSheetName = SHEET_CONFIGS[0].key;
  let currentDashFilter = 'ALL';
  let activeFilter = null;
  let refreshTimer = null;
  let refreshMs = 60000;

  function handleCredentialResponse(response) {
    const payload = JSON.parse(decodeURIComponent(atob(response.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
    currentUser = { email: payload.email, token: response.credential };
    document.getElementById('loading').style.display = 'flex';
    callApi('verify').then(res => {
      if(res.ok) {
        currentUser.permission = res.permission;
        initApp();
      } else {
        alert(res.msg);
        document.getElementById('loading').style.display = 'none';
      }
    });
  }

  function initApp() {
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('appView').classList.remove('hidden');
    
    if(currentUser.permission === 'ADMIN' || currentUser.permission === 'LEADER') {
      document.getElementById('btnAdd').classList.remove('hidden');
    }

    const isMobile = window.innerWidth < 768;
    const isPowerUser = currentUser.permission === 'ADMIN';
    if(isPowerUser && !isMobile) refreshMs = 30000; 
    else if(isMobile) refreshMs = 60000; 
    else refreshMs = 120000; 
    
    renderRefreshCtrl();
    renderSheetSelector();
    renderDashFilters(); 
    loadAllData(true);
    startTimer();
    startClock();
  }

  function startClock() {
    setInterval(() => {
      const now = new Date();
      document.getElementById('headerClock').textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
    }, 1000);
  }

  async function loadAllData(force = false) {
    if(!force) document.getElementById('loading').style.display = 'none';
    const res = await callApi('getAllData');
    if(res.ok) {
      allData = res.allSheets;
      renderDashboard();
      if(!document.getElementById('tabOp').classList.contains('hidden')){
         renderList(); 
      }
    }
    document.getElementById('loading').style.display = 'none';
  }

  async function callApi(action, data = {}) {
    try {
      const res = await fetch(SCRIPT_URL, { 
        method: 'POST', 
        body: JSON.stringify({ action, token: currentUser?.token, ...data }) 
      });
      return await res.json();
    } catch(e) { return { ok: false, msg: 'ÈÄ£Á∑öÈåØË™§' }; }
  }

  // ================= UI: DASHBOARD =================
  function renderDashFilters() {
    const box = document.getElementById('dashFilters');
    box.innerHTML = '';
    
    const allBtn = document.createElement('button');
    const isAllActive = currentDashFilter === 'ALL';
    allBtn.className = `filter-btn`;
    if(isAllActive) {
        allBtn.style.background = '#334155';
        allBtn.style.color = '#fff';
        allBtn.style.borderColor = '#334155';
    }
    allBtn.textContent = 'ÂÖ®ÈÉ®ÊÉÖÂ†±';
    allBtn.onclick = () => { currentDashFilter = 'ALL'; renderDashFilters(); renderDashboard(); };
    box.appendChild(allBtn);

    SHEET_CONFIGS.forEach(cfg => {
      const btn = document.createElement('button');
      const isActive = currentDashFilter === cfg.key;
      btn.className = `filter-btn`;
      if(isActive) {
        btn.style.backgroundColor = cfg.color;
        btn.style.borderColor = cfg.color;
        btn.style.color = '#fff';
      } else {
        btn.style.color = cfg.color;
        btn.style.borderColor = cfg.color;
      }
      btn.textContent = cfg.key;
      btn.onclick = () => { currentDashFilter = cfg.key; renderDashFilters(); renderDashboard(); };
      box.appendChild(btn);
    });
  }

  function renderDashboard() {
    const container = document.getElementById('dashContent');
    container.innerHTML = '';

    SHEET_CONFIGS.forEach(cfg => {
      if(currentDashFilter !== 'ALL' && currentDashFilter !== cfg.key) return;

      const data = allData[cfg.key];
      if(!data || !data.headers) return; 

      const wrapper = document.createElement('div');
      wrapper.className = 'dash-section';
      wrapper.innerHTML = `<div class="dash-title" style="color:${cfg.color}; border-color:${cfg.color}">${cfg.key}</div>`;

      const steps = cfg.steps;
      const parkingStep = cfg.parkingField;
      const parkingIdx = steps.indexOf(parkingStep);
      
      const inbound = parkingIdx >= 0 ? steps.slice(0, parkingIdx) : steps;
      const outbound = parkingIdx >= 0 ? steps.slice(parkingIdx + 1) : [];

      inbound.forEach(step => wrapper.appendChild(createStatCard(step, data, cfg)));

      // Location Stats (Clickable)
      if(parkingStep) {
        const locContainer = document.createElement('div');
        locContainer.className = 'loc-container';
        const colIdx = data.headers.findIndex(h => h.name === parkingStep);
        const counts = {};
        STOP_OPTIONS.forEach(s => counts[s] = 0);
        data.rows.forEach(r => {
          const val = (r[colIdx] || '').trim();
          if(counts[val] !== undefined) counts[val]++;
        });
        STOP_OPTIONS.forEach(loc => {
          const card = document.createElement('div');
          card.className = 'loc-card';
          card.innerHTML = `<div class="loc-name">${loc}</div><div class="loc-val">${counts[loc]}</div>`;
          // Click to Manage Location
          if(currentUser.permission === 'ADMIN' || currentUser.permission === 'LEADER') {
             card.onclick = () => openLocationSheet(loc, cfg.key);
          }
          locContainer.appendChild(card);
        });
        wrapper.appendChild(locContainer);
      }

      if(outbound.length > 0) {
        const outTitle = document.createElement('div');
        outTitle.className = 'step-header';
        outTitle.style.marginTop = '16px';
        outTitle.textContent = 'ÈÄÄÂ†¥Á®ãÂ∫è';
        wrapper.appendChild(outTitle);
        outbound.forEach(step => wrapper.appendChild(createStatCard(step, data, cfg)));
      }

      const dynamicHeaders = data.headers.filter(h => h.isDynamic);
      if(dynamicHeaders.length > 0) {
        const summaryBox = createSummaryTable(data, dynamicHeaders, cfg);
        if(summaryBox) wrapper.appendChild(summaryBox);
      }

      container.appendChild(wrapper);
    });
  }

  function createSummaryTable(data, dynamicHeaders, cfg) {
    const rows = [];
    const carIdx = data.headers.findIndex(h => h.name === 'ËªäËôü');
    const areaIdx = data.headers.findIndex(h => h.name.includes('ÂçÄÂüü') || h.name.includes('Á∑®Ëôü'));

    data.rows.forEach(r => {
      dynamicHeaders.forEach(dh => {
        const colIdx = data.headers.indexOf(dh);
        const val = (r[colIdx] || '').trim();
        if(val && val !== 'Skip' && val !== '-') {
          rows.push({ car: r[carIdx], area: r[areaIdx], station: dh.name, time: val });
        }
      });
    });

    if(rows.length === 0) return null;

    const box = document.createElement('div');
    box.className = 'stat-card'; 
    box.style.padding = '12px';
    let html = `<div class="dash-title" style="color:${cfg.color}; border-color:${cfg.color}; margin-top:0;">Êñ∞Â¢ûÁ´ôÈªûÁ¥ÄÈåÑ</div>
    <table class="summary-table">
      <tr><th>ËªäËôü</th><th>ÂçÄÂüü</th><th>Âú∞Èªû</th><th>ÊôÇÈñì</th></tr>`;
    rows.forEach(r => {
      html += `<tr><td>${r.car}</td><td>${r.area}</td><td>${r.station}</td><td>${r.time}</td></tr>`;
    });
    html += '</table>';
    box.innerHTML = html;
    return box;
  }

  function createStatCard(step, data, cfg) {
    const colIdx = data.headers.findIndex(h => h.name === step);
    let done = 0, todo = 0;
    data.rows.forEach(row => {
      const val = (row[colIdx] || '').trim();
      (val && val !== 'Skip' && val !== '-') ? done++ : todo++;
    });

    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `
      <div class="step-header">${step}</div>
      <div class="stat-row">
        <div class="stat-box" onclick="goToFilter('${cfg.key}', '${step}', 'done')">
          <div class="stat-num num-done">${done}</div>
          <div class="stat-lbl">ÂÆåÊàê</div>
        </div>
        <div class="stat-box" onclick="goToFilter('${cfg.key}', '${step}', 'todo')">
          <div class="stat-num num-todo" style="${todo===0?'color:#ccc':''}">${todo}</div>
          <div class="stat-lbl">Êú™ÂÆåÊàê</div>
        </div>
      </div>`;
    return card;
  }

  // ================= UI: LIST (TAB 2) =================
  function renderList() {
    const data = allData[currentSheetName];
    if(!data || !data.headers) return;

    const container = document.getElementById('listContainer');
    container.innerHTML = '';
    const header = data.headers;
    const carIdx = header.findIndex(h => h.name === 'ËªäËôü');
    let areaIdx = header.findIndex(h => h.name === 'ÂçÄÂüüËªäÊ¨°Á∑®Ëôü');
    if (areaIdx === -1) areaIdx = header.findIndex(h => h.name.includes('ÂçÄÂüü'));

    let rows = data.rows;
    // Apply Filter
    if(activeFilter) {
      document.getElementById('filterMsg').classList.remove('hidden');
      document.getElementById('filterText').textContent = `ÁØ©ÈÅ∏: ${activeFilter.step} (${activeFilter.status === 'done' ? 'ÂÆåÊàê' : 'Êú™ÂÆåÊàê'})`;
      const stepIdx = header.findIndex(h => h.name === activeFilter.step);
      rows = rows.filter(r => {
        const val = (r[stepIdx] || '').trim();
        const isDone = (val && val !== '-' && val !== 'Skip');
        return activeFilter.status === 'done' ? isDone : !isDone;
      });
    } else {
      document.getElementById('filterMsg').classList.add('hidden');
    }

    // Prepare rows with Progress calculation for sorting
    const cfg = SHEET_CONFIGS.find(s => s.key === currentSheetName);
    const renderItems = rows.map((row, idx) => {
        // 1. Calculate Standard Progress & Find Latest Standard Status
        let stdCompletedCount = 0;
        let latestStdTime = ''; // Used for comparison
        let displayStatus = 'Â∞öÊú™ÈñãÂßã';
        
        cfg.steps.forEach(step => {
            const hIdx = header.findIndex(h => h.name === step);
            const val = (row[hIdx] || '').trim();
            if(val && val !== '-') {
                stdCompletedCount++;
                // Update latest standard status
                if(step === cfg.parkingField) {
                    displayStatus = val;
                    // Parking doesn't usually have time, treat as "now" or ignore for time comparison?
                    // Let's treat it as a status update.
                } else if(val === 'Skip') {
                    displayStatus = `${step} (Áï•ÈÅé)`;
                    // Skip has no time, so it won't be overridden by dynamic stations unless dynamic has time?
                    // Let's assume Skip is "current".
                } else {
                    displayStatus = `${step} ${val}`;
                    latestStdTime = val; // "HH:mm:ss"
                }
            }
        });

        // 2. Find Matching Dynamic Stations (Time > Latest Std Time)
        const dynamicHeaders = header.filter(h => h.isDynamic);
        let dynamicUpdates = [];
        
        dynamicHeaders.forEach(dh => {
            const hIdx = header.indexOf(dh);
            const val = (row[hIdx] || '').trim();
            if(val && val !== '-' && val !== 'Skip') {
                // If there is a standard time, compare. If no standard time (only Skip or nothing), show dynamic.
                if(!latestStdTime || val > latestStdTime) {
                    dynamicUpdates.push({ name: dh.name, time: val });
                }
            }
        });

        // Sort dynamic updates by time ascending
        dynamicUpdates.sort((a, b) => a.time.localeCompare(b.time));

        // 3. Construct Final Status String (Multi-line)
        let finalStatusHtml = displayStatus;
        if(dynamicUpdates.length > 0) {
            dynamicUpdates.forEach(u => {
                finalStatusHtml += `\n${u.name} ${u.time}`;
            });
        }

        // Check if ALL standard steps are done
        const isAllDone = stdCompletedCount === cfg.steps.length;

        return { row, stdCompletedCount, finalStatusHtml, isAllDone, originalIdx: idx };
    });

    // Sort: Progress (Ascending - less done first), then Original Index
    renderItems.sort((a, b) => {
        if (a.stdCompletedCount !== b.stdCompletedCount) return a.stdCompletedCount - b.stdCompletedCount;
        return a.originalIdx - b.originalIdx;
    });

    if(renderItems.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ÁÑ°Á¨¶ÂêàË≥áÊñô</div>';
      return;
    }

    renderItems.forEach(item => {
      const card = document.createElement('div');
      card.className = `veh-card ${item.isAllDone ? 'completed' : ''}`;
      
      // Determine color for status
      let statusStyle = '';
      if(item.finalStatusHtml.includes('Áï•ÈÅé')) statusStyle = 'color: var(--c-brand);'; 
      else if(item.finalStatusHtml === 'Â∞öÊú™ÈñãÂßã') statusStyle = 'color: #94a3b8; font-weight:500;';
      
      const btnIcon = item.isAllDone ? '‚úì' : '+';
      
      card.innerHTML = `
        <div class="txt-car">${item.row[carIdx] || ''}</div>
        <div class="txt-area">${item.row[areaIdx] || ''}</div>
        <div class="veh-status" style="${statusStyle}">${item.finalStatusHtml}</div>
        <div class="btn-expand">${btnIcon}</div>
      `;
      card.onclick = () => openBottomSheet(item.row, header, carIdx, areaIdx);
      container.appendChild(card);
    });
  }

  // ================= MANAGERS =================
  function openBottomSheet(row, header, carIdx, areaIdx) {
    const title = document.getElementById('sheetTitle');
    // Title format: "291-CC ÂÆâÂíå1Ëªä"
    title.textContent = `${row[carIdx]} ${row[areaIdx]}`;
    const body = document.getElementById('sheetBody');
    body.innerHTML = '';

    const cfg = SHEET_CONFIGS.find(s => s.key === currentSheetName);
    const isViewer = currentUser.permission === 'VIEWER';

    let allSteps = [...cfg.steps];
    const dynamicHeaders = header.filter(h => h.isDynamic).map(h => h.name);
    const standardCount = allSteps.length;
    allSteps = allSteps.concat(dynamicHeaders);

    allSteps.forEach((step, index) => {
      if(index === standardCount) {
        const sep = document.createElement('div'); sep.className = 'dynamic-sep';
        const head = document.createElement('div'); head.className = 'dynamic-title'; head.textContent = 'Êñ∞Â¢ûÁ´ôÈªû';
        body.appendChild(sep);
        body.appendChild(head);
      }

      const hIdx = header.findIndex(h => h.name === step);
      const val = (row[hIdx] || '').trim();
      
      const rowDiv = document.createElement('div');
      rowDiv.className = 'action-row';
      const left = document.createElement('div');
      left.className = 'action-label';
      left.textContent = step;
      rowDiv.appendChild(left);

      const mid = document.createElement('div');
      mid.className = 'action-mid';
      
      const right = document.createElement('div');
      right.className = 'action-right';
      
      if(step === cfg.parkingField) {
        if(!isViewer) {
          const sel = document.createElement('select');
          sel.className = 'sheet-select';
          sel.innerHTML = `<option value="">---- Ê∏ÖÈô§ ----</option>` + STOP_OPTIONS.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('');
          sel.onchange = () => doAction(row[carIdx], step, sel.value, true);
          // For parking, put select in middle? Or right? 
          // Previous design put it in right. Let's put in right for better touch target.
          right.appendChild(sel);
        } else {
          mid.innerHTML = `<span class="action-time" style="color:#000">${val || '-'}</span>`;
        }
      } 
      else {
        if(val && val !== 'Skip' && val !== '-') {
          mid.innerHTML = `<span class="action-time">${val}</span>`;
          if(!isViewer) {
             const div = document.createElement('div'); div.className = 'btn-group';
             div.innerHTML = `
               <button class="btn-solid btn-mod" onclick="modifyTime('${row[carIdx]}', '${step}', '${val}')">‰øÆÊîπ</button>
               <button class="btn-solid btn-del" onclick="doAction('${row[carIdx]}', '${step}', '')">Âà™Èô§</button>
             `;
             right.appendChild(div);
          }
        } else if(val === 'Skip' || val === '-') {
          mid.innerHTML = `<span class="action-skip">Â∑≤Áï•ÈÅé</span>`;
          if(!isViewer) {
             const div = document.createElement('div'); div.className = 'btn-group';
             div.innerHTML = `
               <button class="btn-solid btn-mod" onclick="modifyTime('${row[carIdx]}', '${step}', '')">‰øÆÊîπ</button>
               <button class="btn-solid btn-del" onclick="doAction('${row[carIdx]}', '${step}', '')">Âà™Èô§</button>
             `;
             right.appendChild(div);
          }
        } else {
          // Empty
          if(!isViewer) {
            const div = document.createElement('div'); div.className = 'btn-group';
            div.innerHTML = `
              <button class="btn-solid btn-do" onclick="doAction('${row[carIdx]}', '${step}', null)">ÊâìÂç°</button>
              <button class="btn-solid btn-skip" onclick="doAction('${row[carIdx]}', '${step}', '-')">Áï•ÈÅé</button>
            `;
            right.appendChild(div);
          } else {
            // mid.innerHTML = '<span style="color:#ccc">-</span>';
          }
        }
      }
      rowDiv.appendChild(mid);
      rowDiv.appendChild(right);
      body.appendChild(rowDiv);
    });

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('bottomSheet').classList.add('show');
  }

  // ================= LOCATION MANAGEMENT (TAB 1) =================
  function openLocationSheet(locName, sheetKey) {
    const title = document.getElementById('sheetTitle');
    title.textContent = `${locName}`; // Just location name
    const body = document.getElementById('sheetBody');
    body.innerHTML = '';

    const data = allData[sheetKey];
    if(!data) return;
    
    const cfg = SHEET_CONFIGS.find(s => s.key === sheetKey);
    const parkingField = cfg.parkingField;
    const parkingIdx = data.headers.findIndex(h => h.name === parkingField);
    const carIdx = data.headers.findIndex(h => h.name === 'ËªäËôü');
    const areaIdx = data.headers.findIndex(h => h.name.includes('ÂçÄÂüü') || h.name.includes('Á∑®Ëôü'));

    // 1. Current Vehicles List
    const currentVehicles = data.rows.filter(r => (r[parkingIdx] || '').trim() === locName);
    
    body.innerHTML += `<div class="action-label" style="margin-bottom:8px;">ÁèæÊúâËªäËºõ (${currentVehicles.length})</div>`;
    
    if(currentVehicles.length === 0) {
        body.innerHTML += `<div style="padding:10px; color:#999;">ÁÑ°ËªäËºõ</div>`;
    } else {
        currentVehicles.forEach(r => {
            const div = document.createElement('div');
            div.className = 'loc-list-item';
            div.innerHTML = `
                <div class="loc-list-txt">${r[areaIdx]} ${r[carIdx]}</div>
                <button class="btn-remove-loc" onclick="doAssignLoc('${sheetKey}', '${r[carIdx]}', '${parkingField}', '')">ÁßªÈô§</button>
            `;
            body.appendChild(div);
        });
    }

    // 2. Add Vehicle Section (Admin/Leader only)
    const sep = document.createElement('div'); sep.className = 'dynamic-sep';
    const head = document.createElement('div'); head.className = 'dynamic-title'; head.textContent = 'Âä†ÂÖ•ËªäËºõ';
    body.appendChild(sep);
    body.appendChild(head);

    // Candidates: Vehicles with NO parking location
    const candidates = data.rows.filter(r => {
        const val = (r[parkingIdx] || '').trim();
        return !val || val === '-';
    });

    if(candidates.length > 0) {
        const sel = document.createElement('select');
        sel.id = 'selAddLocCar';
        sel.className = 'sheet-select';
        sel.style.marginBottom = '12px';
        sel.innerHTML = `<option value="">Ë´ãÈÅ∏ÊìáËªäËºõ</option>` + 
            candidates.map(r => `<option value="${r[carIdx]}">${r[areaIdx]} ${r[carIdx]}</option>`).join('');
        
        const btn = document.createElement('button');
        btn.className = 'btn-solid btn-do';
        btn.style.width = '100%';
        btn.textContent = 'Á¢∫ÂÆöÂä†ÂÖ•';
        btn.onclick = () => {
            const carNo = document.getElementById('selAddLocCar').value;
            if(!carNo) return alert('Ë´ãÈÅ∏ÊìáËªäËºõ');
            doAssignLoc(sheetKey, carNo, parkingField, locName);
        };

        body.appendChild(sel);
        body.appendChild(btn);
    } else {
        body.innerHTML += `<div style="color:#999;">ÁÑ°ÂèØÂä†ÂÖ•ÁöÑËªäËºõ</div>`;
    }

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('bottomSheet').classList.add('show');
  }

  async function doAssignLoc(sheetKey, carNo, colName, value) {
    const originalSheet = currentSheetName;
    currentSheetName = sheetKey; 
    await doAction(carNo, colName, value, true);
    currentSheetName = originalSheet; 
  }

  // ================= ACTIONS =================
  async function doAction(carNo, colName, value, isUpdate = false) {
    document.getElementById('loading').style.display = 'flex';
    closeSheet();
    const action = isUpdate ? 'update' : 'stamp';
    await callApi(action, { sheetName: currentSheetName, carNo, colName, value });
    await loadAllData(true);
  }

  function modifyTime(carNo, step, oldVal) {
    const newVal = prompt('‰øÆÊîπÊôÇÈñì:', oldVal || '');
    if(newVal !== null) doAction(carNo, step, newVal, true);
  }

  function promptAddColumn() {
    const name = prompt("Ë´ãËº∏ÂÖ•Êñ∞Á´ôÈªûÂêçÁ®±:");
    if(name) {
      document.getElementById('loading').style.display = 'flex';
      callApi('addColumn', { sheetName: currentSheetName, colName: name }).then(() => loadAllData(true));
    }
  }

  function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    const btns = document.querySelectorAll('.nav-tab');
    if(tab === 'dash') btns[0].classList.add('active');
    else btns[1].classList.add('active');
    
    if(tab === 'dash') {
      document.getElementById('tabDash').classList.remove('hidden');
      document.getElementById('tabOp').classList.add('hidden');
    } else {
      document.getElementById('tabDash').classList.add('hidden');
      document.getElementById('tabOp').classList.remove('hidden');
      renderList(); 
    }
  }

  function goToFilter(sheetKey, step, status) {
    currentSheetName = sheetKey;
    activeFilter = { step, status };
    document.getElementById('sheetSelector').value = sheetKey;
    currentDashFilter = sheetKey;
    renderDashFilters();
    switchTab('op');
  }

  function clearFilter() { activeFilter = null; renderList(); }
  function onSheetChange() { currentSheetName = document.getElementById('sheetSelector').value; activeFilter = null; renderList(); }
  
  function closeSheet() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('bottomSheet').classList.remove('show');
  }

  function renderSheetSelector() {
    const sel = document.getElementById('sheetSelector');
    sel.innerHTML = SHEET_CONFIGS.map(s => `<option value="${s.key}">${s.key}</option>`).join('');
  }

  function renderRefreshCtrl() {
    const box = document.getElementById('refreshCtrl');
    box.innerHTML = REFRESH_OPTIONS.map(opt => 
      `<button class="refresh-btn ${refreshMs===opt.ms?'active':''}" onclick="setRefresh(${opt.ms})">${opt.label}</button>`
    ).join('');
  }

  function setRefresh(ms) { refreshMs = ms; renderRefreshCtrl(); startTimer(); }
  function startTimer() { if(refreshTimer) clearInterval(refreshTimer); refreshTimer = setInterval(() => loadAllData(false), refreshMs); }
  function logout() { localStorage.removeItem('ddcc_user_token'); location.reload(); }
</script>
</body>
</html>
