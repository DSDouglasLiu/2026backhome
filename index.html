<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026 è»Šæµé€€å ´ä½œæ¥­ç³»çµ±</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* =========================================
       1. Design Tokens (æ•´åˆæ–°èˆŠé¢¨æ ¼)
       ========================================= */
    :root {
      /* Palette */
      --color-brand-500: #1f6fe5;
      --color-brand-600: #2563EB;
      --color-bg-app: #f8fafc;
      --color-surface: #ffffff;
      --color-text-main: #0f172a;
      --color-text-sub: #64748b;
      --color-border: #e2e8f0;
      
      /* Dashboard Colors (èˆŠç‰ˆé…è‰²) */
      --c-teal: #059669;
      --c-orange: #f97316;
      --c-purple: #7c3aed;
      --c-pink: #db2777;

      /* Spacing & Radius */
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-pill: 50px;
      
      /* Z-Index */
      --z-bottom-sheet: 1100;
      --z-overlay: 1000;
      --z-header: 500;

      --app-max-width:800px; /* è¨­å®šåˆé©å¯¬åº¦ */
    }

    body { 
      margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      background: #e5e7eb; /* é›»è…¦ç‰ˆèƒŒæ™¯æ·±ç° */
      color: var(--color-text-main); 
      padding-bottom: 0; /* padding æ”¹ç”± appView æ§åˆ¶ */
      -webkit-tap-highlight-color: transparent;
    }

    /* æ ¸å¿ƒå®¹å™¨è¨­å®š */
    #appView {
      max-width: var(--app-max-width);
      margin: 0 auto;
      background-color: var(--color-bg-app);
      min-height: 100vh;
      box-shadow: 0 0 30px rgba(0,0,0,0.1);
      padding-bottom: 80px; /* åŸæœ¬ body çš„ padding ç§»åˆ°é€™è£¡ */
    }

    /* Bottom Sheet ä¿®æ­£ */
    .bottom-sheet {
      position: fixed; bottom: 0; left: 50%; right: auto; 
      width: 100%; max-width: var(--app-max-width);
      transform: translate(-50%, 100%); /* åˆå§‹éš±è— */
      background: #fff;
      border-radius: 20px 20px 0 0; padding: 24px; 
      transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: var(--z-bottom-sheet); max-height: 85vh; overflow-y: auto; 
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      box-sizing: border-box;
    }
    
    /* é€™è£¡éå¸¸é‡è¦ï¼šè¦è“‹æ‰åŸæœ¬çš„ .bottom-sheet.show */
    .bottom-sheet.show {
       transform: translate(-50%, 0) !important;
    }

    /* =========================================
       2. Layout & Header
       ========================================= */
    .container { max-width: 800px; margin: 0 auto; padding: 16px; }
    
    .app-header {
      background: var(--color-surface); padding: 12px 16px;
      position: sticky; top: 0; z-index: var(--z-header);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex; flex-direction: column; gap: 12px;
    }

    .top-bar { display: flex; justify-content: space-between; align-items: center; }
    .app-title { font-size: 1.2rem; font-weight: 800; color: var(--color-brand-500); }
    
    /* é »ç‡åˆ‡æ›å™¨ (ä»¿èˆŠç‰ˆ) */
    .refresh-ctrl { display: flex; background: #f1f5f9; padding: 2px; border-radius: var(--radius-pill); }
    .refresh-btn { 
      border: none; background: transparent; padding: 4px 10px; 
      font-size: 12px; font-weight: 600; color: var(--color-text-sub); 
      border-radius: var(--radius-pill); cursor: pointer; transition: 0.2s;
    }
    .refresh-btn.active { background: #fff; color: var(--color-brand-500); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

    /* Tab åˆ‡æ›å™¨ */
    .nav-tabs { display: flex; gap: 8px; margin-top: 4px; }
    .nav-tab {
      flex: 1; padding: 10px; border: none; background: transparent;
      font-size: 15px; font-weight: 600; color: var(--color-text-sub);
      border-bottom: 3px solid transparent; cursor: pointer; transition: 0.2s;
    }
    .nav-tab.active { color: var(--color-brand-500); border-bottom-color: var(--color-brand-500); }

    /* =========================================
       3. Tab 1: Dashboard (çœ‹æ¿) - ç§»æ¤èˆŠç‰ˆæ¨£å¼
       ========================================= */
    .dash-section { margin-bottom: 24px; animation: fadeIn 0.3s; }
    .dash-title { 
      font-size: 15px; font-weight: 700; margin-bottom: 12px; 
      padding-left: 8px; border-left: 4px solid var(--color-brand-500); 
      display: flex; justify-content: space-between; align-items: center;
    }
    
    /* çµ±è¨ˆå¡ç‰‡ */
    .stat-card {
      background: var(--color-surface); border-radius: var(--radius-lg);
      padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid var(--color-border);
    }
    .step-header { font-size: 16px; font-weight: 700; margin-bottom: 12px; }
    
    .stat-row { display: flex; gap: 12px; }
    .stat-box {
      flex: 1; text-align: center; background: #f8fafc;
      border-radius: var(--radius-md); padding: 12px 8px; cursor: pointer;
    }
    .stat-box:active { background: #e2e8f0; }
    .stat-num { font-size: 26px; font-weight: 800; line-height: 1.1; }
    .stat-lbl { font-size: 12px; color: var(--color-text-sub); margin-top: 4px; }
    .num-done { color: var(--color-brand-500); }
    .num-todo { color: #ef4444; }

    /* Assign Block (æ´¾è»Šå€å¡Š) */
    .assign-block {
      background: #fffbeb; border: 2px dashed var(--c-orange);
      border-radius: var(--radius-lg); padding: 16px; margin-bottom: 16px;
    }
    .assign-title { font-size: 14px; font-weight: 700; color: #b45309; margin-bottom: 8px; }
    .form-select {
      width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1;
      background: #fff; font-size: 15px; margin-bottom: 8px;
    }
    .btn-assign {
      width: 100%; padding: 10px; background: var(--c-orange); color: white;
      border: none; border-radius: 8px; font-weight: 700; font-size: 15px;
    }

    /* Location Scroll (RWD) */
    .loc-container {
      display: flex; gap: 10px; padding-bottom: 4px;
      /* Mobile: Scroll */
      overflow-x: auto; 
    }
    /* Desktop: Grid */
    @media (min-width: 768px) {
      .loc-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); overflow-x: visible; }
    }
    .loc-card {
      min-width: 110px; background: var(--color-surface); border: 1px solid var(--color-border);
      border-radius: var(--radius-md); padding: 12px; text-align: center; flex-shrink: 0;
    }
    .loc-name { font-size: 13px; font-weight: 600; color: var(--color-text-sub); margin-bottom: 4px; }
    .loc-val { font-size: 20px; font-weight: 800; color: var(--color-brand-500); }

    /* =========================================
       4. Tab 2: Operation (ä½œæ¥­åˆ—è¡¨) - æ–°ç‰ˆæ¨£å¼
       ========================================= */
    .op-toolbar { 
      display: flex; gap: 8px; margin-bottom: 16px; align-items: center; 
      background: #fff; padding: 10px; border-radius: var(--radius-md); box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .op-select { flex: 1; padding: 8px; border: 1px solid var(--color-border); border-radius: 6px; font-size: 15px; }
    .btn-add { 
      padding: 8px 12px; background: #fff; border: 1px solid var(--color-brand-500); 
      color: var(--color-brand-500); border-radius: 6px; font-weight: 600; cursor: pointer; white-space: nowrap;
    }

    /* åˆ—è¡¨è¦–åœ– (List/Card) */
    .veh-card {
      background: var(--color-surface); border-radius: var(--radius-md);
      padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border-left: 4px solid transparent; cursor: pointer; transition: 0.2s;
      display: flex; justify-content: space-between; align-items: center;
    }
    .veh-card:active { transform: scale(0.98); }
    .veh-info h3 { margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color: var(--color-text-main); }
    .veh-info p { margin: 0; font-size: 13px; color: var(--color-text-sub); }
    .veh-status { font-size: 14px; font-weight: 600; color: var(--color-brand-500); text-align: right; }
    .veh-status span { display: block; font-size: 12px; color: #999; font-weight: 400; }

    /* ç¯©é¸æç¤ºæ¢ */
    .filter-bar {
      background: #eff6ff; color: var(--color-brand-600); padding: 8px 12px;
      border-radius: 8px; margin-bottom: 12px; font-size: 14px; display: flex;
      justify-content: space-between; align-items: center; border: 1px solid #bfdbfe;
    }
    .filter-clear { text-decoration: underline; cursor: pointer; font-weight: 700; }

    /* =========================================
       5. Overlays (Bottom Sheet, Loading)
       ========================================= */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: var(--z-overlay); backdrop-filter: blur(2px); }
    .bottom-sheet {
      position: fixed; bottom: -100%; left: 0; right: 0; background: #fff;
      border-radius: 20px 20px 0 0; padding: 24px; transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: var(--z-bottom-sheet); max-height: 85vh; overflow-y: auto; box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    }
    .sheet-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .sheet-title { font-size: 20px; font-weight: 800; }
    
    .action-row { 
      display: flex; justify-content: space-between; align-items: center; 
      padding: 12px 0; border-bottom: 1px dashed #eee; 
    }
    .action-label { font-size: 15px; font-weight: 600; }
    .action-val { font-family: monospace; color: var(--color-text-sub); margin-right: 10px; }
    
    .btn-action { 
      padding: 8px 16px; border-radius: 20px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; 
    }
    .btn-do { background: var(--color-brand-500); color: white; }
    .btn-edit { background: #f1f5f9; color: var(--color-text-sub); }
    
    /* åœè»Šä¸‹æ‹‰é¸å–® (åœ¨ Bottom Sheet å…§) */
    .sheet-select { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }

    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--color-brand-500); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Login View */
    #loginView { display: flex; height: 100vh; flex-direction: column; align-items: center; justify-content: center; background: #fff; }
    .hidden { display: none !important; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<div id="loginView">
  <h2 style="color: var(--color-brand-600); margin-bottom: 24px;">2026 è»Šæµé€€å ´ä½œæ¥­</h2>
  <div id="g_id_onload"
       data-client_id="368914333961-tr57ogs6ig2cgfqqi5j5ml6h2ic67cd1.apps.googleusercontent.com" 
       data-callback="handleCredentialResponse"
       data-auto_select="true">
  </div>
  <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"></div>
</div>

<div id="appView" class="hidden">
  <header class="app-header">
    <div class="top-bar">
      <div class="app-title">è»Šæµäººæµé€€å ´</div>
      <div class="refresh-ctrl" id="refreshCtrl">
        </div>
      <button class="refresh-btn" onclick="logout()">ç™»å‡º</button>
    </div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('dash')">çœ‹æ¿</button>
      <button class="nav-tab" onclick="switchTab('op')">ä½œæ¥­</button>
    </div>
  </header>

  <div class="container">
    
    <div id="tabDash" class="dash-section">
      <div id="dashContent"></div>
    </div>

    <div id="tabOp" class="hidden">
      <div class="op-toolbar">
        <select id="sheetSelector" class="op-select" onchange="onSheetChange()"></select>
        <button id="btnAdd" class="btn-add hidden" onclick="promptAddColumn()">+ ç«™é»</button>
      </div>
      
      <div id="filterMsg" class="filter-bar hidden">
        <span id="filterText"></span>
        <span class="filter-clear" onclick="clearFilter()">é¡¯ç¤ºå…¨éƒ¨</span>
      </div>

      <div id="listContainer"></div>
    </div>

  </div>
</div>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-head">
    <div class="sheet-title" id="sheetTitle">è»Šè¼›è³‡è¨Š</div>
    <div style="font-size:24px; color:#999; cursor:pointer;" onclick="closeSheet()">âœ•</div>
  </div>
  <div id="sheetBody"></div>
</div>

<div id="loading"><div class="spinner"></div></div>

<script>
  // ================= CONFIG =================
  // â˜…â˜…â˜… è«‹å‹™å¿…ç¢ºèªé€™æ˜¯æ‚¨æœ€æ–°éƒ¨ç½²çš„ Web App URL â˜…â˜…â˜…
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwzLPpv2wBq9D2Ao4W4KrRoEX3LPvJgrpxa5IUBGG2YPSSB0fQ4Hnk2dbqOpXLUJjIq4A/exec'; 
  
  const SHEET_CONFIGS = [
    { 
      key:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰', colorClass:'--c-teal', color:'#059669',
      steps: ['è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š','Call è»Šä¸Šè¡Œæ','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå‰å¾€æ’è»ŠéšŠ','è»Šæš«åœä½ç½®','é€€å ´äººå“¡å·²åˆ°é½Š','å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°','äººå·²å‰å¾€å¹³å°æ­è»Š','è»Šç¬¬äºŒæ¬¡ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'],
      parkingField: 'è»Šæš«åœä½ç½®'
    },
    { 
      key:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰', colorClass:'--c-orange', color:'#d97706',
      steps: ['è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š','Call è»Šä¸Šè¡Œæ','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','é›¢é–‹éŠè¦½è»Šå¹³å°','é€šééŠè¦½è»Šå¹³å°å‰å¾€æ’è»ŠéšŠ','è»Šåœé ä½ç½®','äººå·²å‰å¾€ç¦ªå ‚å¹³å°æ­è»Š','è»Šå·²é›¢é–‹ç¦ªå ‚å¹³å°'],
      parkingField: 'è»Šåœé ä½ç½®'
    },
    { 
      key:'æ°´é™¸å°ˆè»Šé€€å ´', colorClass:'--c-purple', color:'#7c3aed',
      steps: ['ç¢ºèªè»Šå·²æŠµé”åœ’å€','è»Šæš«åœä½ç½®','é€€å ´äººå“¡å·²åˆ°é½Š','å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','äººå¾è»Šåº«å‰å¾€å¹³å°æ­è»Š','è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'],
      parkingField: 'è»Šæš«åœä½ç½®'
    },
    { 
      key:'288æ³•é’é€€å ´', colorClass:'--c-pink', color:'#db2777',
      steps: ['é€€å ´äººå“¡å·²åˆ°é½Š','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°']
    }
  ];

  const STOP_OPTIONS = ['ğŸ…¿ï¸ ç¦ªå ‚å¹³å°','ğŸ…¿ï¸ æ³•å¿ƒåŒ—è·¯','ğŸ…¿ï¸ æ³•å¿ƒå—è·¯ï¼ˆè¥¿ï¼‰','ğŸ…¿ï¸ æ³•å¿ƒå—è·¯ï¼ˆæ±ï¼‰','ğŸ…¿ï¸ æ³•å¤§è·¯','ğŸ…¿ï¸ é›™ç’°è·¯è‡³æ³•å¤§ä¸€æ©‹'];
  const REFRESH_OPTIONS = [
    { label:'5åˆ†', ms:300000 }, { label:'2åˆ†', ms:120000 }, { label:'60ç§’', ms:60000 }, { label:'30ç§’', ms:30000 }
  ];

  // ================= STATE =================
  let currentUser = null;
  let allData = {}; // Cache for all sheets
  let currentSheetName = SHEET_CONFIGS[0].key;
  let activeFilter = null; 
  let refreshTimer = null;
  let refreshMs = 60000; 

  // ================= CORE =================
  function handleCredentialResponse(response) {
    const payload = JSON.parse(decodeURIComponent(atob(response.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
    currentUser = { email: payload.email, token: response.credential };
    
    document.getElementById('loading').style.display = 'flex';
    callApi('verify').then(res => {
      if(res.ok) {
        currentUser.permission = res.permission;
        currentUser.name = payload.name;
        initApp();
      } else {
        alert(res.msg);
        document.getElementById('loading').style.display = 'none';
      }
    });
  }

  function initApp() {
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('appView').classList.remove('hidden');
    
    if(currentUser.permission === 'ADMIN' || currentUser.permission === 'LEADER') {
      document.getElementById('btnAdd').classList.remove('hidden');
    }

    const isMobile = window.innerWidth < 768;
    const isPowerUser = currentUser.permission === 'ADMIN';
    if(isPowerUser && !isMobile) refreshMs = 30000; 
    else if(isMobile) refreshMs = 60000; 
    else refreshMs = 120000; 
    
    renderRefreshCtrl();
    renderSheetSelector();
    
    loadAllData(true);
    startTimer();
  }

  async function loadAllData(force = false) {
    if(!force) document.getElementById('loading').style.display = 'none';
    
    const res = await callApi('getAllData');
    if(res.ok) {
      allData = res.allSheets;
      renderDashboard();
      // å¦‚æœç›®å‰æ˜¯åœ¨ä½œæ¥­é é¢ï¼Œä¹Ÿè¦é‡æ–°æ¸²æŸ“åˆ—è¡¨
      if(!document.getElementById('tabOp').classList.contains('hidden')){
         renderList(); 
      }
    }
    document.getElementById('loading').style.display = 'none';
  }

  async function callApi(action, data = {}) {
    const payload = { action, token: currentUser?.token, ...data };
    try {
      const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
      return await res.json();
    } catch(e) {
      console.error(e);
      return { ok: false, msg: 'é€£ç·šéŒ¯èª¤' };
    }
  }

  // ================= UI: DASHBOARD =================
  function renderDashboard() {
    const container = document.getElementById('dashContent');
    container.innerHTML = '';

    SHEET_CONFIGS.forEach(cfg => {
      const data = allData[cfg.key];
      // ä¿®æ­£é»ï¼šå¾Œç«¯å›å‚³çš„æ˜¯ headers (è¤‡æ•¸)
      if(!data || !data.rows || !data.headers) return; 

      const wrapper = document.createElement('div');
      wrapper.className = 'dash-section';
      
      wrapper.innerHTML = `<div class="dash-title" style="color:${cfg.color}; border-color:${cfg.color}">${cfg.key}</div>`;

      const steps = cfg.steps;
      const parkingStep = cfg.parkingField;
      const parkingIdx = steps.indexOf(parkingStep);
      
      const inbound = parkingIdx >= 0 ? steps.slice(0, parkingIdx) : steps;
      const outbound = parkingIdx >= 0 ? steps.slice(parkingIdx + 1) : [];

      inbound.forEach(step => wrapper.appendChild(createStatCard(step, data, cfg)));

      // Assign Block
      if(parkingStep && currentUser.permission === 'ADMIN') {
        const assignBlock = createAssignBlock(data, cfg, parkingStep);
        if(assignBlock) wrapper.appendChild(assignBlock);
      }

      // Location Stats
      if(parkingStep) {
        const locContainer = document.createElement('div');
        locContainer.className = 'loc-container';
        // ä¿®æ­£é»ï¼šä½¿ç”¨ headers (è¤‡æ•¸)ï¼Œä¸”æ¯”å° h.name
        const colIdx = data.headers.findIndex(h => h.name === parkingStep);
        const counts = {};
        STOP_OPTIONS.forEach(s => counts[s] = 0);
        
        data.rows.forEach(r => {
          const val = (r[colIdx] || '').trim();
          if(counts[val] !== undefined) counts[val]++;
        });

        STOP_OPTIONS.forEach(loc => {
          const card = document.createElement('div');
          card.className = 'loc-card';
          card.innerHTML = `<div class="loc-name">${loc}</div><div class="loc-val">${counts[loc]}</div>`;
          locContainer.appendChild(card);
        });
        wrapper.appendChild(locContainer);
      }

      // Outbound
      if(outbound.length > 0) {
        const outTitle = document.createElement('div');
        outTitle.className = 'step-header';
        outTitle.style.marginTop = '16px';
        outTitle.textContent = 'é€€å ´ç¨‹åº';
        wrapper.appendChild(outTitle);
        outbound.forEach(step => wrapper.appendChild(createStatCard(step, data, cfg)));
      }

      container.appendChild(wrapper);
    });
  }

  function createStatCard(step, data, cfg) {
    // ä¿®æ­£é»ï¼šä½¿ç”¨ headers
    const colIdx = data.headers.findIndex(h => h.name === step);
    let done = 0, todo = 0;
    data.rows.forEach(row => {
      const val = (row[colIdx] || '').trim();
      (val && val !== 'Skip' && val !== '-') ? done++ : todo++;
    });

    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `
      <div class="step-header">${step}</div>
      <div class="stat-row">
        <div class="stat-box" onclick="goToFilter('${cfg.key}', '${step}', 'done')">
          <div class="stat-num num-done">${done}</div>
          <div class="stat-lbl">å®Œæˆ</div>
        </div>
        <div class="stat-box" onclick="goToFilter('${cfg.key}', '${step}', 'todo')">
          <div class="stat-num num-todo" style="${todo===0?'color:#ccc':''}">${todo}</div>
          <div class="stat-lbl">æœªå®Œæˆ</div>
        </div>
      </div>
    `;
    return card;
  }

  function createAssignBlock(data, cfg, parkingStep) {
    // ä¿®æ­£é»ï¼šä½¿ç”¨ headers
    const colIdx = data.headers.findIndex(h => h.name === parkingStep);
    const candidates = data.rows.filter(r => {
      const val = (r[colIdx] || '').trim();
      return !val || val === '-';
    });
    
    if(candidates.length === 0) return null;

    const div = document.createElement('div');
    div.className = 'assign-block';
    
    // ä¿®æ­£é»ï¼šä½¿ç”¨ headers
    const carIdx = data.headers.findIndex(h => h.name === 'è»Šè™Ÿ');
    const areaIdx = data.headers.findIndex(h => h.name.includes('å€åŸŸ') || h.name.includes('ç·¨è™Ÿ'));
    
    let carOpts = `<option value="">è«‹é¸æ“‡è»Šè¼›...</option>`;
    candidates.forEach((r) => {
      // é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œç›´æ¥ç”¨è»Šè™Ÿç•¶ valueã€‚å¯¦éš›é€å‡ºæ™‚å†åæŸ¥ indexã€‚
      // æ³¨æ„ï¼šdoQuickAssign éœ€è¦æ”¹å¯«ä»¥æ”¯æ´ç”¨è»Šè™ŸæŸ¥æ‰¾ã€‚
      carOpts += `<option value="${r[carIdx]}">${r[areaIdx]} ${r[carIdx]}</option>`;
    });

    let locOpts = `<option value="">è«‹é¸æ“‡ä½ç½®...</option>` + STOP_OPTIONS.map(s => `<option value="${s}">${s}</option>`).join('');

    div.innerHTML = `
      <div class="assign-title">è»Šæš«åœä½ç½®ç™»éŒ„</div>
      <select class="form-select" id="assignLoc_${cfg.key}">${locOpts}</select>
      <select class="form-select" id="assignCar_${cfg.key}">${carOpts}</select>
      <button class="btn-assign" onclick="doQuickAssign('${cfg.key}', '${parkingStep}')">ç¢ºå®š</button>
    `;
    return div;
  }

  // ================= UI: OPERATION LIST =================
  // ================= UI: OPERATION LIST =================
  function renderList() {
    const data = allData[currentSheetName];
    if(!data || !data.headers) return;

    const container = document.getElementById('listContainer');
    container.innerHTML = '';

    const header = data.headers;
    const carIdx = header.findIndex(h => h.name === 'è»Šè™Ÿ');
    // æŠ“å–å€åŸŸæ¬„ä½ (ç›¸å®¹ 'å€åŸŸè»Šæ¬¡ç·¨è™Ÿ' æˆ– 'ç·¨è™Ÿ')
    const areaIdx = header.findIndex(h => h.name.includes('å€åŸŸ') || h.name.includes('ç·¨è™Ÿ'));
    
    // éæ¿¾é‚è¼¯ (Filter)
    let rows = data.rows;
    if(activeFilter) {
      document.getElementById('filterMsg').classList.remove('hidden');
      document.getElementById('filterText').textContent = `ç¯©é¸: ${activeFilter.step} (${activeFilter.status === 'done' ? 'å®Œæˆ' : 'æœªå®Œæˆ'})`;
      
      const stepIdx = header.findIndex(h => h.name === activeFilter.step);
      rows = rows.filter(r => {
        const val = (r[stepIdx] || '').trim();
        const isDone = (val && val !== '-' && val !== 'Skip');
        return activeFilter.status === 'done' ? isDone : !isDone;
      });
    } else {
      document.getElementById('filterMsg').classList.add('hidden');
    }

    if(rows.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ç„¡ç¬¦åˆè³‡æ–™</div>';
      return;
    }

    rows.forEach(row => {
      const card = document.createElement('div');
      card.className = 'veh-card';
      
      // åˆ¤æ–·é¡¯ç¤ºç‹€æ…‹
      let statusText = 'é»æ“Šæ“ä½œ'; // é è¨­æ–‡å­—
      const parkingStep = SHEET_CONFIGS.find(c=>c.key===currentSheetName).parkingField;
      
      // å¦‚æœæœ‰åœè»Šä½ï¼Œå„ªå…ˆé¡¯ç¤ºåœè»Šä½
      if(parkingStep) {
        const pIdx = header.findIndex(h => h.name === parkingStep);
        const pVal = (row[pIdx] || '').trim();
        if(pVal) statusText = pVal; 
      }

      // ç”Ÿæˆ HTMLï¼šå·¦å´(è»Šè™Ÿ+å€åŸŸ) / å³å´(ç‹€æ…‹)
      card.innerHTML = `
        <div class="veh-left">
          <div class="txt-car">${row[carIdx] || ''}</div>
          <div class="txt-area">${row[areaIdx] || ''}</div>
        </div>
        <div class="veh-status">
          ${statusText}
        </div>
      `;
      
      card.onclick = () => openBottomSheet(row, header, carIdx);
      container.appendChild(card);
    });
  }

  function openBottomSheet(row, header, carIdx) {
    const title = document.getElementById('sheetTitle');
    title.textContent = row[carIdx];
    const body = document.getElementById('sheetBody');
    body.innerHTML = '';

    const cfg = SHEET_CONFIGS.find(s => s.key === currentSheetName);
    const isViewer = currentUser.permission === 'VIEWER';

    cfg.steps.forEach(step => {
      const hIdx = header.findIndex(h => h.name === step);
      const val = (row[hIdx] || '').trim();
      
      const rowDiv = document.createElement('div');
      rowDiv.className = 'action-row';
      
      const left = document.createElement('div');
      left.innerHTML = `<div class="action-label">${step}</div>`;
      rowDiv.appendChild(left);

      const right = document.createElement('div');
      
      if(step === cfg.parkingField) {
        if(!isViewer) {
          const sel = document.createElement('select');
          sel.className = 'sheet-select';
          sel.innerHTML = `<option value="">æœªè¨­å®š</option>` + STOP_OPTIONS.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('');
          
          const btn = document.createElement('button');
          btn.className = 'btn-action btn-do';
          btn.textContent = 'æ›´æ–°';
          btn.style.marginLeft = '8px';
          btn.onclick = () => doAction(row[carIdx], step, sel.value);
          
          right.appendChild(sel);
          right.appendChild(btn);
        } else {
          right.innerHTML = `<span class="action-val">${val || '-'}</span>`;
        }
      } 
      else {
        if(val) {
          right.innerHTML = `<span class="action-val">${val}</span>`;
          if(!isViewer) {
             const btn = document.createElement('button');
             btn.className = 'btn-action btn-edit';
             btn.textContent = 'ä¿®æ”¹';
             btn.onclick = () => {
               const newVal = prompt('ä¿®æ­£æ™‚é–“:', val);
               if(newVal !== null) doAction(row[carIdx], step, newVal, true);
             };
             right.appendChild(btn);
          }
        } else {
          if(!isViewer) {
            const btn = document.createElement('button');
            btn.className = 'btn-action btn-do';
            btn.textContent = 'æ‰“å¡';
            btn.onclick = () => doAction(row[carIdx], step, null, false); // stamp
            right.appendChild(btn);
          } else {
            right.innerHTML = '<span style="color:#ccc">æœªå®Œæˆ</span>';
          }
        }
      }
      rowDiv.appendChild(right);
      body.appendChild(rowDiv);
    });

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('bottomSheet').style.bottom = '0';
  }

  // ================= ACTIONS =================
  async function doAction(carNo, colName, value, isUpdate = false) {
    document.getElementById('loading').style.display = 'flex';
    closeSheet();
    
    const action = isUpdate ? 'update' : 'stamp';
    
    await callApi(action, {
      sheetName: currentSheetName,
      carNo: carNo,
      colName: colName,
      value: value
    });
    
    // å¼·åˆ¶é‡æ–°è®€å–æ‰€æœ‰è³‡æ–™ä»¥æ›´æ–° Dashboard å’Œ List
    await loadAllData(true);
  }

  async function doQuickAssign(sheetKey, colName) {
    const loc = document.getElementById(`assignLoc_${sheetKey}`).value;
    const carNo = document.getElementById(`assignCar_${sheetKey}`).value;
    if(!loc || !carNo) return alert('è«‹é¸æ“‡ä½ç½®èˆ‡è»Šè¼›');
    
    // é€™è£¡æˆ‘å€‘éœ€è¦åˆ‡æ› currentSheetName è®“ doAction çŸ¥é“è¦æ“ä½œå“ªå€‹ Sheet
    // å› ç‚º Assign Block å¯èƒ½åœ¨ä¸åŒçš„ Sheet å¡ç‰‡ä¸Š
    const originalSheet = currentSheetName;
    currentSheetName = sheetKey; 
    
    await doAction(carNo, colName, loc, true);
    
    // é‚„åŸ Sheet Name (æˆ–æ˜¯ç›´æ¥åœç•™åœ¨è©² Sheet ä¹Ÿå¯ä»¥)
    currentSheetName = originalSheet;
  }

  function promptAddColumn() {
    const name = prompt("è«‹è¼¸å…¥æ–°ç«™é»åç¨±:");
    if(name) {
      document.getElementById('loading').style.display = 'flex';
      callApi('addColumn', { sheetName: currentSheetName, colName: name }).then(() => loadAllData(true));
    }
  }

  // ================= NAVIGATION =================
  function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    // ç°¡å–®åˆ¤æ–·æŒ‰éˆ•æ–‡å­—æˆ– index
    const btns = document.querySelectorAll('.nav-tab');
    if(tab === 'dash') btns[0].classList.add('active');
    else btns[1].classList.add('active');
    
    if(tab === 'dash') {
      document.getElementById('tabDash').classList.remove('hidden');
      document.getElementById('tabOp').classList.add('hidden');
    } else {
      document.getElementById('tabDash').classList.add('hidden');
      document.getElementById('tabOp').classList.remove('hidden');
      renderList(); 
    }
  }

  function goToFilter(sheetKey, step, status) {
    currentSheetName = sheetKey;
    activeFilter = { step, status };
    document.getElementById('sheetSelector').value = sheetKey;
    
    switchTab('op');
  }

  function clearFilter() {
    activeFilter = null;
    renderList();
  }

  function onSheetChange() {
    currentSheetName = document.getElementById('sheetSelector').value;
    activeFilter = null; 
    renderList();
  }

  function closeSheet() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('bottomSheet').style.bottom = '-100%';
  }

  // ================= HELPERS =================
  function renderSheetSelector() {
    const sel = document.getElementById('sheetSelector');
    sel.innerHTML = SHEET_CONFIGS.map(s => `<option value="${s.key}">${s.key}</option>`).join('');
  }

  function renderRefreshCtrl() {
    const box = document.getElementById('refreshCtrl');
    box.innerHTML = REFRESH_OPTIONS.map(opt => 
      `<button class="refresh-btn ${refreshMs===opt.ms?'active':''}" onclick="setRefresh(${opt.ms})">${opt.label}</button>`
    ).join('');
  }

  function setRefresh(ms) {
    refreshMs = ms;
    renderRefreshCtrl();
    startTimer();
  }

  function startTimer() {
    if(refreshTimer) clearInterval(refreshTimer);
    refreshTimer = setInterval(() => loadAllData(false), refreshMs);
  }

  function logout() {
    localStorage.removeItem('ddcc_user_token');
    location.reload();
  }
</script>  

</body>
</html>
