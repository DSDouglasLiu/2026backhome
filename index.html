<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026 è»Šæµé€€å ´ä½œæ¥­ç³»çµ±</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* =========================================
       1. Design Tokens (æ•´åˆ token.css & Primitive CSV)
       ========================================= */
    :root {
      /* Palette */
      --color-brand-500: #3B82F6;
      --color-brand-600: #2563EB;
      --color-success-500: #22C55E;
      --color-success-100: #dcfce7;
      --color-warning-500: #F59E0B;
      --color-bg-app-shell: #f8fafc;
      --color-surface: #ffffff;
      --color-text-main: #0f172a;
      --color-text-sub: #64748b;
      --color-border: #e2e8f0;
      
      /* Spacing & Radius */
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --radius-md: 12px;
      --radius-lg: 16px;
      
      /* Layers (Z-Index) */
      --layer-tabbar: 100;
      --layer-overlay: 1000;
      --layer-bottom-sheet: 1100;
    }

    /* =========================================
       2. App Shell (æ•´åˆ style.css)
       ========================================= */
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      background: var(--color-bg-app-shell); 
      color: var(--color-text-main); 
      padding-bottom: 80px; /* Safe area for scrolling */
      -webkit-tap-highlight-color: transparent;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: var(--spacing-md); }
    
    .header { 
      display: flex; justify-content: space-between; align-items: center; 
      margin-bottom: var(--spacing-md); 
      background: var(--color-surface);
      padding: 12px;
      border-radius: var(--radius-md);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    select { 
      padding: 8px 12px; border: 1px solid var(--color-border); 
      border-radius: 6px; font-size: 1rem; max-width: 200px;
    }

    button.nav-btn {
      padding: 8px 12px; background: white; border: 1px solid var(--color-border);
      border-radius: 6px; cursor: pointer; color: var(--color-text-main);
    }

    /* =========================================
       3. RWD Views (Card vs Table)
       ========================================= */
    .view-card { display: block; }
    .view-table { display: none; }
    
    @media (min-width: 768px) {
      .view-card { display: none; }
      .view-table { display: block; }
    }

    /* Card Style (Mobile) */
    .card { 
      background: var(--color-surface); 
      border-radius: var(--radius-md); 
      padding: var(--spacing-md); 
      margin-bottom: 12px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    .card-head { 
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; font-weight: 700; font-size: 1.1rem; 
      border-bottom: 1px solid var(--color-border);
      padding-bottom: 8px;
    }
    .status-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); 
      gap: 8px; 
    }

    /* Table Style (Desktop) */
    table { width: 100%; border-collapse: collapse; background: var(--color-surface); }
    th, td { border: 1px solid var(--color-border); padding: 10px; text-align: center; font-size: 0.9rem; }
    th { background: #f1f5f9; font-weight: 600; white-space: nowrap; }

    /* =========================================
       4. Status Components
       ========================================= */
    .btn-status { 
      padding: 8px 4px; 
      border-radius: 8px; 
      border: 1px solid var(--color-border); 
      background: #f8fafc; 
      font-size: 0.85rem; 
      cursor: pointer; 
      text-align: center;
      min-height: 48px; /* Touch friendly */
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .btn-status strong { display: block; font-size: 0.75rem; color: var(--color-text-sub); margin-bottom: 2px; }
    .btn-status span { font-weight: 600; font-size: 0.9rem; }
    
    /* State: Done */
    .btn-status.done { 
      background: var(--color-success-100); 
      color: #166534; 
      border-color: #bbf7d0; 
    }
    /* State: Skip */
    .btn-status.skip { 
      background: #f1f5f9; 
      color: #94a3b8; 
      text-decoration: line-through; 
    }
    /* State: Dynamic (Temporary) */
    .is-dynamic { 
      border: 2px dashed var(--color-warning-500); 
      background: #fffbeb;
    }

    /* =========================================
       5. Bottom Sheet & Overlays
       ========================================= */
    .overlay { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
      display: none; z-index: var(--layer-overlay); 
      backdrop-filter: blur(2px);
    }
    .bottom-sheet { 
      position: fixed; bottom: -100%; left: 0; right: 0; 
      background: var(--color-surface); 
      border-radius: var(--radius-lg) var(--radius-lg) 0 0; 
      padding: 24px; 
      transition: bottom 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
      z-index: var(--layer-bottom-sheet); 
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    }
    .sheet-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
    .sheet-actions { display: flex; flex-direction: column; gap: 12px; }
    
    .btn-lg { 
      padding: 14px; border-radius: 12px; border: none; 
      font-size: 1rem; font-weight: 600; cursor: pointer; 
      display: flex; align-items: center; justify-content: center;
    }
    .btn-primary { background: var(--color-brand-500); color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
    .btn-outline { background: transparent; border: 1px solid var(--color-border); color: var(--color-text-main); }
    .btn-ghost { background: transparent; color: var(--color-text-sub); }

    /* Loading */
    .loading { 
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
      background: rgba(0,0,0,0.8); color: white; padding: 16px 24px; 
      border-radius: 8px; display: none; z-index: 2000; font-weight: bold;
    }
  </style>
</head>
<body>

<div id="loading" class="loading">è³‡æ–™è™•ç†ä¸­...</div>

<div id="loginView" style="display:flex; height:100vh; justify-content:center; align-items:center; flex-direction:column; background: #fff;">
  <h2 style="color: var(--color-brand-600); margin-bottom: 24px;">2026 è»Šæµé€€å ´ä½œæ¥­</h2>
  <div id="g_id_onload"
       data-client_id="368914333961-tr57ogs6ig2cgfqqi5j5ml6h2ic67cd1.apps.googleusercontent.com" 
       data-callback="handleCredentialResponse"
       data-auto_select="true">
  </div>
  <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"></div>
</div>

<div id="appView" style="display:none;">
  <div class="container">
    <div class="header">
      <select id="sheetSelector" onchange="loadData()">
        <option value="åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰">åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰</option>
        <option value="åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰">åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰</option>
        <option value="æ°´é™¸å°ˆè»Šé€€å ´">æ°´é™¸å°ˆè»Šé€€å ´</option>
        <option value="288æ³•é’é€€å ´">288æ³•é’é€€å ´</option>
      </select>
      <div style="display:flex; gap:8px;">
        <button id="btnAddCol" class="nav-btn" onclick="promptAddColumn()" style="display:none; color:var(--color-warning-500); border-color:var(--color-warning-500);">+ ç«™é»</button>
        <button class="nav-btn" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <div id="cardContainer" class="view-card"></div>
    
    <div class="view-table">
      <table id="dataTable">
        <thead><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-title" id="sheetTitle">æ“ä½œé¸å–®</div>
  <div class="sheet-actions">
    <button class="btn-lg btn-primary" onclick="doStamp()">
      <span>ğŸ•’ ç«‹å³æ‰“å¡ (ç¾åœ¨)</span>
    </button>
    
    <div style="display:flex; gap:12px;">
      <input type="time" id="manualTime" class="btn-lg btn-outline" style="flex:1; font-family:inherit;">
      <button class="btn-lg btn-outline" style="flex:1;" onclick="doUpdate()">æ›´æ–°æ™‚é–“</button>
    </div>
    
    <button class="btn-lg btn-outline" onclick="doSkip()" style="color: var(--color-text-sub);">
      ğŸš« ç•¥éæ­¤ç«™ (Skip)
    </button>
    <button class="btn-lg btn-ghost" onclick="closeSheet()">å–æ¶ˆ</button>
  </div>
</div>

<script>
  let currentUser = null;
  let currentSheetData = null;
  let activeTarget = null; // { carNo, colName }
  const SCRIPT_URL = https://script.google.com/macros/s/AKfycbzjKiKHUA4uO29bTj80_pRRbGdgbsBMsKmkJoTy31ZUU4cuy-Gcx3Oafb-FRaXBBPjT/exec
  // === Auth ===
  function handleCredentialResponse(response) {
    const idToken = response.credential;
    const payload = JSON.parse(atob(idToken.split('.')[1]));
    currentUser = { email: payload.email, token: idToken }; 
    
    document.getElementById('loading').style.display = 'block';
    // å‘¼å«å¾Œç«¯ API: verify
    google.script.run
      .withSuccessHandler(res => {
        document.getElementById('loading').style.display = 'none';
        if(res.ok) {
          currentUser.permission = res.permission;
          document.getElementById('loginView').style.display = 'none';
          document.getElementById('appView').style.display = 'block';
          
          if(['ADMIN', 'LEADER'].includes(res.permission)) {
            document.getElementById('btnAddCol').style.display = 'inline-block';
          }
          loadData();
        } else {
          alert('ç™»å…¥å¤±æ•—: ' + res.msg);
        }
      })
      .withFailureHandler(err => {
         document.getElementById('loading').style.display = 'none';
         alert('ç³»çµ±éŒ¯èª¤: ' + err);
      })
      .doGet({ parameter: { action: 'verify', userEmail: currentUser.email } }); 
      // æ³¨æ„: google.script.run åªèƒ½å‘¼å« Server functionï¼Œ
      // é€™è£¡ç‚ºäº†ç›¸å®¹ doGet è·¯ç”±æ¶æ§‹ï¼Œæˆ‘å€‘ç›´æ¥å‘¼å«åŒ…è£å¥½çš„ Controller 
      // å»ºè­°: å¯¦ä½œä¸€å€‹ runApi function åœ¨å¾Œç«¯å°ˆé–€çµ¦ google.script.run å‘¼å«
  }
  
  // ä¿®æ­£: ç‚ºäº†è®“ google.script.run é †åˆ©é‹ä½œï¼Œå»ºè­°åœ¨å¾Œç«¯åŠ ä¸€å€‹ function runApi(req)
  // å¦‚æœä¸è¡Œï¼Œé€™è£¡æ”¹ç”¨ fetch WebApp URL (éœ€ç™¼å¸ƒç‚º Web App)
  // ç‚ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œä»¥ä¸‹å‡è¨­æ‚¨æœƒå°‡å¾Œç«¯ doPost/doGet é‚è¼¯å°è£å¥½ã€‚
  // **å¯¦æˆ°å»ºè­°**: ä¿®æ”¹ code.gs å¢åŠ ä¸€å€‹ `function apiHandler(req) { ... }` ä¾›å‰ç«¯ç›´æ¥å‘¼å«
  
  function callApi(action, data) {
    const payload = { ...data, action, userEmail: currentUser?.email };
    
    return new Promise((resolve, reject) => {
       // ä½¿ç”¨ google.script.run (æ¨è–¦)
       google.script.run
         .withSuccessHandler(resolve)
         .withFailureHandler(reject)
         .doPost({ postData: { contents: JSON.stringify(payload) } });
    });
  }

  function logout() {
    currentUser = null;
    location.reload();
  }

  // === Data Loading ===
  function loadData() {
    const sheetName = document.getElementById('sheetSelector').value;
    document.getElementById('loading').style.display = 'block';
    
    callApi('getData', { sheetName }).then(res => {
      document.getElementById('loading').style.display = 'none';
      if(res.ok) {
        currentSheetData = res;
        render(res);
      } else {
        alert('è®€å–å¤±æ•—: ' + res.msg);
      }
    }).catch(e => {
       document.getElementById('loading').style.display = 'none';
       alert('é€£ç·šéŒ¯èª¤: ' + e);
    });
  }

  // === Rendering ===
  function render(data) {
    const { headers, rows } = data;
    const container = document.getElementById('cardContainer');
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    
    container.innerHTML = '';
    thead.innerHTML = '';
    tbody.innerHTML = '';

    // å®šç¾©å“ªäº›æ¬„ä½æ˜¯ç´”è³‡è¨Š (ä¸å¯é»æ“Š)
    // ä¾æ“šæ–°çš„è¦æ ¼ï¼šç·¨è™Ÿ, å€åŸŸè»Šæ¬¡ç·¨è™Ÿ, è»Šè™Ÿ, å‚™è¨»
    const infoCols = ['ç·¨è™Ÿ', 'å€åŸŸè»Šæ¬¡ç·¨è™Ÿ', 'è»Šè™Ÿ', 'å‚™è¨»'];

    // 1. Render Table Header
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h.name;
      thead.appendChild(th);
    });

    // 2. Render Rows
    rows.forEach(row => {
      const carNoIdx = headers.findIndex(h => h.name === 'è»Šè™Ÿ');
      const carNo = row[carNoIdx] || 'Unknown';
      const noteIdx = headers.findIndex(h => h.name === 'å‚™è¨»');
      const note = row[noteIdx] || '';
      
      // -- Mobile Card --
      const card = document.createElement('div');
      card.className = 'card';
      let gridHtml = '';
      
      // Card Header: è»Šè™Ÿ + å‚™è¨»
      card.innerHTML = `
        <div class="card-head">
          <span style="font-size:1.2rem; color:var(--color-brand-600)">${carNo}</span>
          <span style="font-size:0.85rem; color:var(--color-text-sub); font-weight:normal">${note}</span>
        </div>`;

      // -- Desktop Table Row --
      const tr = document.createElement('tr');

      headers.forEach((h, idx) => {
        const val = row[idx] || '';
        const isDynamic = h.isDynamic;
        const isInfo = infoCols.includes(h.name);
        
        // Render Cell
        // è‹¥æœ‰å€¼é¡¯ç¤ºå€¼ï¼Œè‹¥ç„¡å€¼ä¸”éè³‡è¨Šæ¬„ä½é¡¯ç¤º â­• (Table)
        // æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•ï¼šé¡¯ç¤ºæ¬„ä½åç¨± + å€¼
        const cellClass = `btn-status ${val ? 'done' : ''} ${val==='-' || val==='Skip' ? 'skip' : ''} ${isDynamic ? 'is-dynamic' : ''}`;
        
        const clickAttr = isInfo ? '' : `onclick="openSheet('${carNo}', '${h.name}')"`;
        
        // Grid Item (Mobile) - åªé¡¯ç¤ºæ“ä½œæŒ‰éˆ•
        if (!isInfo) {
          gridHtml += `
            <div class="${cellClass}" ${clickAttr}>
              <strong>${h.name}</strong>
              <span>${val || '-'}</span>
            </div>`;
        }

        // Table Cell (Desktop)
        const td = document.createElement('td');
        if(!isInfo) {
          td.innerHTML = `<div class="${cellClass}" ${clickAttr}><span>${val}</span></div>`;
        } else {
          td.textContent = val;
        }
        tr.appendChild(td);
      });

      card.innerHTML += `<div class="status-grid">${gridHtml}</div>`;
      container.appendChild(card);
      tbody.appendChild(tr);
    });
  }

  // === Action Logic ===
  function openSheet(carNo, colName) {
    if(currentUser.permission === 'VIEWER') return; 

    activeTarget = { carNo, colName };
    document.getElementById('sheetTitle').textContent = `${carNo} : ${colName}`;
    
    // è¨­å®šç›®å‰æ™‚é–“
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    document.getElementById('manualTime').value = `${hh}:${mm}`;

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('bottomSheet').style.bottom = '0';
  }

  function closeSheet() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('bottomSheet').style.bottom = '-100%';
    activeTarget = null;
  }

  function doStamp() {
    sendAction('stamp', null);
  }

  function doUpdate() {
    const val = document.getElementById('manualTime').value;
    if(!val) return alert('è«‹é¸æ“‡æ™‚é–“');
    sendAction('update', val);
  }

  function doSkip() {
    sendAction('stamp', '-');
  }
  
  function promptAddColumn() {
    const name = prompt("è«‹è¼¸å…¥æ–°ç«™é»åç¨± (å°‡æ–°å¢è‡³æœ€å¾Œ):");
    if(name) {
      const sheetName = document.getElementById('sheetSelector').value;
      document.getElementById('loading').style.display = 'block';
      callApi('addColumn', { sheetName, colName: name }).then(res => {
        document.getElementById('loading').style.display = 'none';
        if(res.ok) { alert('æ–°å¢æˆåŠŸ'); loadData(); }
        else { alert('å¤±æ•—: ' + res.msg); }
      });
    }
  }

  function sendAction(actType, val) {
    if(!activeTarget) return;
    const sheetName = document.getElementById('sheetSelector').value;
    
    const payload = {
      sheetName,
      carNo: activeTarget.carNo,
      colName: activeTarget.colName,
      value: val
    };

    document.getElementById('loading').style.display = 'block';
    closeSheet();

    callApi(actType, payload).then(res => {
      document.getElementById('loading').style.display = 'none';
      if(res.ok) {
        loadData(); 
      } else {
        alert('Error: ' + res.msg);
      }
    });
  }
</script>
</body>
</html>
