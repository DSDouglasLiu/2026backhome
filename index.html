<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026 è»Šæµé€€å ´ä½œæ¥­ç³»çµ±</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* =========================================
       1. Design Tokens & Colors (Mobile First)
       ========================================= */
    :root {
      /* Brand Colors */
      --c-brand: #1f6fe5;       /* ä¸»è‰²è— (Primary) */
      --c-brand-dark: #1e40af;  /* æ·±è— */
      
      /* Functional Colors */
      --c-success: #22c55e;     /* ç¶ è‰² (ä¿®æ”¹/å®Œæˆ) */
      --c-danger: #ef4444;      /* ç´…è‰² (åˆªé™¤/æœªå®Œæˆ) */
      --c-neutral: #64748b;     /* ç°è‰² (ç•¥é/æ¬¡è¦) */
      --c-dark: #334155;        /* æ·±ç° (ç³»çµ±æŒ‰éˆ•) */
      
      /* Backgrounds */
      --bg-success-light: #ecfdf5; /* å®Œæˆé …ç›®çš„æ·¡ç¶ åº• */
      --border-success: #10b981;   /* å®Œæˆé …ç›®çš„ç¶ æ¡† */
      --text-success: #047857;     /* å®Œæˆé …ç›®çš„ç¶ å­— */

      /* UI Bases */
      --bg-body: #e5e7eb;
      --bg-app: #f8fafc;
      --bg-surface: #ffffff;
      --border: #e2e8f0;
      
      /* Text Colors */
      --text-main: #0f172a; /* æ·±é»‘ (ä¸»è¦å…§å®¹) */
      --text-sub: #64748b;  /* æ·±ç° (æ¬¡è¦å…§å®¹) */

      /* Metrics */
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-pill: 50px;
      --app-max-width: 800px; /* æ‰‹æ©Ÿç‰ˆæœ€å¤§å¯¬åº¦é™åˆ¶ */
      
      /* Layers */
      --z-bottom: 1100;
      --z-overlay: 1000;
      --z-header: 500;
    }

    body { 
      margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
      background: var(--bg-body); color: var(--text-main); 
      padding-bottom: 0; -webkit-tap-highlight-color: transparent;
    }

    /* App Shell */
    #appView {
      max-width: var(--app-max-width); margin: 0 auto;
      background-color: var(--bg-app); min-height: 100vh;
      box-shadow: 0 0 30px rgba(0,0,0,0.1); padding-bottom: 80px; 
    }

    .container { padding: 12px; } /* Slightly tighter padding for mobile */

    /* =========================================
       2. Header (Sticky & Consolidated)
       ========================================= */
    .app-header {
      background: var(--bg-surface); 
      position: sticky; top: 0; z-index: var(--z-header);
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      padding-bottom: 8px; /* Give some space for the bottom row */
    }

    /* Top Row: Title | Clock | Refresh | Logout */
    .header-main {
      padding: 12px 16px 8px 16px;
      display: grid;
      /* Left (Title) | Center (Time) | Right (Controls) */
      grid-template-columns: 1fr auto 1fr;
      align-items: center; gap: 8px;
    }

    .app-title { 
      font-size: 1.1rem; font-weight: 800; color: var(--c-brand); 
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .header-clock { 
      font-family: monospace; 
      font-size: 1.1rem; font-weight: 800; 
      color: var(--text-main); white-space: nowrap; 
    }

    .header-right { display: flex; justify-content: flex-end; align-items: center; gap: 8px; }

    /* Refresh Buttons */
    .refresh-ctrl { display: flex; background: #f1f5f9; padding: 2px; border-radius: var(--radius-pill); }
    .refresh-btn { 
      border: none; background: transparent; padding: 4px 8px; 
      font-size: 11px; font-weight: 600; color: var(--text-sub); 
      border-radius: var(--radius-pill); cursor: pointer; transition: 0.2s;
    }
    .refresh-btn.active { background: #fff; color: var(--c-brand); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

    /* Logout Button */
    .btn-logout {
      background: var(--c-dark); color: #fff; border: none; padding: 6px 12px;
      border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer;
    }

    /* Level 1 Navigation (Big Pills) - æ•´é«”æƒ…å ± / ç™»éŒ„èˆ‡ä¿®æ”¹ */
    .nav-tabs-wrapper {
      display: flex; gap: 10px; padding: 0 16px 8px 16px; justify-content: center;
    }
    .nav-tab {
      flex: 1; padding: 8px 0; border: none; border-radius: var(--radius-pill);
      font-size: 0.95rem; font-weight: 800; cursor: pointer; transition: 0.2s;
      text-align: center; white-space: nowrap;
      background: #fff; color: var(--c-brand); border: 1px solid var(--c-brand);
    }
    .nav-tab.active { background: var(--c-brand); color: #fff; border-color: var(--c-brand); box-shadow: 0 2px 6px rgba(31, 111, 229, 0.3); }

    /* Level 2 Navigation (Scrollable Pills) - å…¨éƒ¨æƒ…å ± / å„è·¯ç·šæŒ‰éˆ• */
    .nav-scroll-container {
      display: flex; gap: 8px; overflow-x: auto; 
      padding: 4px 16px 8px 16px;
      -webkit-overflow-scrolling: touch; /* iOS Scroll Momentum */
      background: var(--bg-surface);
      /* Hide Scrollbar visually but keep functionality */
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none;  /* IE 10+ */
    }
    .nav-scroll-container::-webkit-scrollbar { 
      display: none; /* Chrome/Safari/Webkit */
    }

    .filter-btn {
      padding: 6px 14px; border-radius: var(--radius-pill); border: 1px solid transparent;
      font-size: 0.85rem; font-weight: 700; white-space: nowrap; cursor: pointer;
      background: #fff; color: var(--text-sub); border-color: var(--border);
      transition: 0.2s; flex-shrink: 0; /* Prevent shrinking */
    }
    
    /* =========================================
       3. Tab 1: Overall Info (çœ‹æ¿)
       ========================================= */
    .dash-section { margin-bottom: 24px; animation: fadeIn 0.3s; }
    .dash-title { 
      font-size: 1.1rem; font-weight: 800; margin-bottom: 12px; 
      padding-left: 10px; border-left: 5px solid var(--c-brand); 
      display: flex; justify-content: space-between; align-items: center; color: var(--text-main);
    }
    
    .stat-card {
      background: var(--bg-surface); border-radius: var(--radius-lg);
      padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
    }
    .step-header { font-size: 1rem; font-weight: 700; margin-bottom: 10px; color: var(--text-main); }
    .stat-row { display: flex; gap: 12px; }
    .stat-box {
      flex: 1; text-align: center; background: #f8fafc;
      border-radius: var(--radius-md); padding: 12px 8px; cursor: pointer;
      border: 1px solid transparent;
    }
    .stat-box:active { background: #e2e8f0; }
    .stat-num { font-size: 2rem; font-weight: 900; line-height: 1.1; } /* Big Number */
    .stat-lbl { font-size: 0.8rem; color: var(--text-sub); margin-top: 4px; font-weight: 600; }
    .num-done { color: var(--c-brand); }
    .num-todo { color: var(--c-danger); }

    /* Location Cards (Peeking & Grid) */
    .loc-container {
      display: flex; gap: 10px; padding-bottom: 8px; 
      overflow-x: auto; scroll-snap-type: x mandatory;
    }
    .loc-card {
      /* Mobile: 42% width ensures ~2.2 cards visible (Peeking effect) */
      flex: 0 0 42%; min-width: 120px; 
      background: var(--bg-surface); border: 1px solid var(--border);
      border-radius: var(--radius-md); padding: 12px; text-align: center; 
      scroll-snap-align: start; cursor: pointer;
      transition: 0.2s;
    }
    .loc-card:active { transform: scale(0.98); background: #f1f5f9; }
    @media (min-width: 768px) {
      .loc-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; overflow-x: visible; }
      .loc-card { flex: unset; min-width: auto; }
    }
    .loc-name { font-size: 0.85rem; font-weight: 600; color: var(--text-sub); margin-bottom: 4px; }
    .loc-val { font-size: 1.5rem; font-weight: 800; color: var(--c-brand); }

    /* Summary Table */
    .summary-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 8px; }
    .summary-table th, .summary-table td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; }
    .summary-table th { color: var(--text-sub); font-weight: 600; font-size: 0.85rem; }
    .summary-table tr:last-child td { border-bottom: none; }
    .summary-table td { color: var(--text-main); font-weight: 500; }
    /* Styles for the Dynamic Station List */
    .summary-time { font-family: monospace; color: var(--text-sub); }
    .summary-loc { color: var(--c-brand); font-weight: 700; }

    /* =========================================
       4. Tab 2: Operation List (Grid Layout)
       ========================================= */
    .op-action-row {
        display: flex; justify-content: center; margin-bottom: 12px;
    }
    .btn-add { 
      padding: 10px 24px; background: #fff; border: 1px solid var(--c-brand); 
      color: var(--c-brand); border-radius: var(--radius-pill); font-weight: 700; cursor: pointer; white-space: nowrap;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05); width: 100%; text-align: center;
    }
    .btn-add:active { background: #f0f9ff; }

    /* List Card - Grid Layout */
    .veh-card {
      background: var(--bg-surface); border-radius: var(--radius-md);
      padding: 12px 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      cursor: pointer; transition: 0.2s; border: 1px solid transparent;
      
      /* Grid: [Info Stack (Fixed 35%)] | [Status Stack (Flexible)] | [Btn (Fixed 40px)] */
      display: grid;
      grid-template-columns: 35% 1fr 40px; 
      align-items: center; gap: 10px;
      min-height: 70px;
    }
    .veh-card:active { transform: scale(0.98); background-color: #f8fafc; }

    /* Left Column Stack (Vehicle Info) */
    .veh-col-left { 
        display: flex; flex-direction: column; gap: 4px; 
        overflow: hidden;
        border-right: 1px solid transparent; 
    }
    
    /* Typography: Both Bold & Large */
    .txt-car { 
        font-size: 1.15rem; font-weight: 800; color: #000; line-height: 1.2; 
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .txt-area { 
        font-size: 1.1rem; /* Large */
        font-weight: 800; /* Bold */
        color: #000;      /* Black */
        line-height: 1.2; 
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    
    /* Middle Column Stack (Status) */
    .veh-col-mid { display: flex; flex-direction: column; gap: 2px; }
    .status-row { font-size: 0.95rem; font-weight: 700; color: var(--c-brand); line-height: 1.3; }
    .status-sep { border-top: 1px dashed #cbd5e1; margin: 4px 0; width: 100%; opacity: 0.5; }
    .status-pending { color: var(--c-neutral); font-weight: 500; }
    /* Dynamic status style */
    .status-dynamic { font-size: 0.9rem; font-weight: 600; color: var(--c-brand-dark); }

    /* Expand Button (+) */
    .btn-expand {
      width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
      background: #eff6ff; color: var(--c-brand); border-radius: 8px; 
      font-weight: 800; font-size: 20px; border: 1px solid #dbeafe;
    }

    /* Completed State */
    .veh-card.completed {
      background-color: var(--bg-success-light);
      border-color: var(--border-success);
    }
    .veh-card.completed .status-row { color: var(--text-success); }
    .veh-card.completed .btn-expand { background: var(--border-success); color: #fff; border-color: var(--border-success); content: "âœ“"; }

    .filter-bar {
      background: #eff6ff; color: var(--c-brand); padding: 8px 12px;
      border-radius: 8px; margin-bottom: 12px; font-size: 0.9rem; display: flex;
      justify-content: space-between; align-items: center; border: 1px solid #bfdbfe;
    }
    .filter-clear { text-decoration: underline; cursor: pointer; font-weight: 700; }

    /* =========================================
       5. Bottom Sheet (Three Column Grid)
       ========================================= */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; z-index: var(--z-overlay); backdrop-filter: blur(2px); }
    .bottom-sheet {
      position: fixed; bottom: 0; left: 50%; right: auto; 
      width: 100%; max-width: var(--app-max-width);
      transform: translate(-50%, 100%); 
      background: #fff; border-radius: 20px 20px 0 0; padding: 24px; 
      transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: var(--z-bottom); max-height: 85vh; overflow-y: auto; 
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15); box-sizing: border-box;
    }
    .bottom-sheet.show { transform: translate(-50%, 0) !important; }

    .sheet-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .sheet-title { font-size: 1.4rem; font-weight: 800; color: #000; }
    
    /* 3-Column Grid: Label | Time | Buttons */
    .action-row { 
      display: grid; 
      /* Label | Time (Center) | Buttons (Right) */
      grid-template-columns: 130px 1fr auto; 
      align-items: center; 
      padding: 12px 0; 
      border-bottom: 1px dashed #eee; 
      gap: 4px;
    }
    
    .action-label { font-size: 1rem; font-weight: 700; color: var(--text-main); text-align: left; }
    .action-mid { text-align: center; } 
    .action-right { display: flex; justify-content: flex-end; } 

    /* Time & Status Colors */
    .action-time { font-family: monospace; font-size: 1rem; font-weight: 700; color: var(--c-brand); }
    .action-skip { font-size: 0.95rem; color: var(--c-brand); font-weight: 700; }

    .dynamic-sep { border-top: 4px solid #f1f5f9; margin: 16px -24px 16px -24px; }
    .dynamic-title { font-size: 1.1rem; font-weight: 800; margin-bottom: 12px; color: var(--text-main); padding-top: 8px; }

    .btn-group { display: flex; gap: 8px; }
    .btn-solid { 
      padding: 8px 14px; border-radius: 6px; border: none; 
      font-size: 0.9rem; font-weight: 700; color: white; cursor: pointer; min-width: 64px; 
      transition: opacity 0.2s;
    }
    .btn-solid:active { opacity: 0.8; }
    
    .btn-do     { background: var(--c-brand); }
    .btn-skip   { background: var(--c-neutral); } /* Gray */
    .btn-mod    { background-color: var(--c-success); }
    .btn-del    { background-color: var(--c-danger); }
    
    .sheet-select { padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; font-weight: 500; width: 100%; }
    
    /* Location Management List Styles */
    .loc-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
    .loc-list-txt { font-size: 1rem; font-weight: 700; color: var(--text-main); }
    .btn-remove-loc { 
      color: #fff; font-size: 0.85rem; font-weight: 700; cursor: pointer; 
      background: var(--c-danger); padding: 6px 12px; border-radius: 6px; border:none; 
    }

    /* Loading & Login */
    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: var(--c-brand); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loginView { display: flex; height: 100vh; flex-direction: column; align-items: center; justify-content: center; background: #fff; }
    .hidden { display: none !important; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

<div id="loginView">
  <h2 style="color: var(--c-brand); margin-bottom: 24px;">2026 è»Šæµé€€å ´ä½œæ¥­</h2>
  <div id="g_id_onload"
       data-client_id="368914333961-tr57ogs6ig2cgfqqi5j5ml6h2ic67cd1.apps.googleusercontent.com" 
       data-callback="handleCredentialResponse"
       data-auto_select="true">
  </div>
  <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"></div>
</div>

<div id="appView" class="hidden">
  <header class="app-header">
    <div class="header-main">
        <div class="app-title">2026æ°´é™¸æ³•æœƒé€€å ´</div>
        <div class="header-clock" id="headerClock">--:--:--</div>
        <div class="header-right">
        <div class="refresh-ctrl" id="refreshCtrl"></div>
        <button class="btn-logout" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>
    
    <div class="nav-tabs-wrapper">
        <button class="nav-tab active" onclick="switchTab('dash')">æ•´é«”æƒ…å ±</button>
        <button class="nav-tab" onclick="switchTab('op')">ç™»éŒ„èˆ‡ä¿®æ”¹</button>
    </div>

    <div class="nav-scroll-container" id="universalNav"></div>
  </header>

  <div class="container">
    <div id="tabDash" class="dash-section">
      <div id="dashContent"></div>
    </div>

    <div id="tabOp" class="hidden">
      <div class="op-action-row">
        <button id="btnAdd" class="btn-add hidden" onclick="promptAddColumn()">+ ç«™é»</button>
      </div>

      <div id="filterMsg" class="filter-bar hidden">
        <span id="filterText"></span>
        <span class="filter-clear" onclick="clearFilter()">é¡¯ç¤ºå…¨éƒ¨</span>
      </div>
      <div id="listContainer"></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-head">
    <div class="sheet-title" id="sheetTitle">è»Šè¼›è³‡è¨Š</div>
    <div style="font-size:24px; color:#999; cursor:pointer;" onclick="closeSheet()">âœ•</div>
  </div>
  <div id="sheetBody"></div>
</div>

<div id="loading"><div class="spinner"></div></div>

<script>
  // ================= CONFIG =================
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwzLPpv2wBq9D2Ao4W4KrRoEX3LPvJgrpxa5IUBGG2YPSSB0fQ4Hnk2dbqOpXLUJjIq4A/exec'; 
  
  const SHEET_CONFIGS = [
    { 
      key:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰', color:'#059669',
      steps: ['è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š','Call è»Šä¸Šè¡Œæ','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå‰å¾€æ’è»ŠéšŠ','è»Šæš«åœä½ç½®','é€€å ´äººå“¡å·²åˆ°é½Š','å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°','äººå·²å‰å¾€å¹³å°æ­è»Š','è»Šç¬¬äºŒæ¬¡ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'],
      parkingField: 'è»Šæš«åœä½ç½®'
    },
    { 
      key:'åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰', color:'#d97706',
      steps: ['è»Šé•·é€šçŸ¥è¡Œæåˆ°é½Š','Call è»Šä¸Šè¡Œæ','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','é›¢é–‹éŠè¦½è»Šå¹³å°','é€šééŠè¦½è»Šå¹³å°å‰å¾€æ’è»ŠéšŠ','è»Šåœé ä½ç½®','äººå·²å‰å¾€ç¦ªå ‚å¹³å°æ­è»Š','è»Šå·²é›¢é–‹ç¦ªå ‚å¹³å°'],
      parkingField: 'è»Šåœé ä½ç½®'
    },
    { 
      key:'æ°´é™¸å°ˆè»Šé€€å ´', color:'#7c3aed',
      steps: ['ç¢ºèªè»Šå·²æŠµé”åœ’å€','è»Šæš«åœä½ç½®','é€€å ´äººå“¡å·²åˆ°é½Š','å·² Call è»Šä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','äººå¾è»Šåº«å‰å¾€å¹³å°æ­è»Š','è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°'],
      parkingField: 'è»Šæš«åœä½ç½®'
    },
    { 
      key:'288æ³•é’é€€å ´', color:'#db2777',
      steps: ['é€€å ´äººå“¡å·²åˆ°é½Š','è»Šå·²ä¸ŠéŠè¦½è»Šå¹³å°','è»Šå·²é›¢é–‹éŠè¦½è»Šå¹³å°']
    }
  ];

  const STOP_OPTIONS = ['ğŸ…¿ï¸ ç¦ªå ‚å¹³å°','ğŸ…¿ï¸ æ³•å¿ƒåŒ—è·¯','ğŸ…¿ï¸ æ³•å¿ƒå—è·¯ï¼ˆè¥¿ï¼‰','ğŸ…¿ï¸ æ³•å¿ƒå—è·¯ï¼ˆæ±ï¼‰','ğŸ…¿ï¸ æ³•å¤§è·¯','ğŸ…¿ï¸ é›™ç’°è·¯è‡³æ³•å¤§ä¸€æ©‹'];
  const REFRESH_OPTIONS = [{ label:'5åˆ†', ms:300000 }, { label:'2åˆ†', ms:120000 }, { label:'60ç§’', ms:60000 }, { label:'30ç§’', ms:30000 }];

  let currentUser = null;
  let allData = {};
  let currentSheetName = SHEET_CONFIGS[0].key;
  let currentDashFilter = 'ALL';
  let activeFilter = null;
  let refreshTimer = null;
  let refreshMs = 60000;

  function handleCredentialResponse(response) {
    const payload = JSON.parse(decodeURIComponent(atob(response.credential.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
    currentUser = { email: payload.email, token: response.credential };
    document.getElementById('loading').style.display = 'flex';
    callApi('verify').then(res => {
      if(res.ok) {
        currentUser.permission = res.permission;
        initApp();
      } else {
        alert(res.msg);
        document.getElementById('loading').style.display = 'none';
      }
    });
  }

  function initApp() {
    document.getElementById('loginView').style.display = 'none';
    document.getElementById('appView').classList.remove('hidden');
    
    if(currentUser.permission === 'ADMIN' || currentUser.permission === 'LEADER') {
      document.getElementById('btnAdd').classList.remove('hidden');
    }

    const isMobile = window.innerWidth < 768;
    const isPowerUser = currentUser.permission === 'ADMIN';
    if(isPowerUser && !isMobile) refreshMs = 30000; 
    else if(isMobile) refreshMs = 60000; 
    else refreshMs = 120000; 
    
    renderRefreshCtrl();
    // Initially render Nav for Dash
    renderNavButtons();
    loadAllData(true);
    startTimer();
    startClock();
  }

  function startClock() {
    setInterval(() => {
      const now = new Date();
      document.getElementById('headerClock').textContent = now.toLocaleTimeString('zh-TW', { hour12: false });
    }, 1000);
  }

  async function loadAllData(force = false) {
    if(!force) document.getElementById('loading').style.display = 'none';
    const res = await callApi('getAllData');
    if(res.ok) {
      allData = res.allSheets;
      renderDashboard();
      if(!document.getElementById('tabOp').classList.contains('hidden')){
         renderList(); 
      }
    }
    document.getElementById('loading').style.display = 'none';
  }

  async function callApi(action, data = {}) {
    try {
      const res = await fetch(SCRIPT_URL, { 
        method: 'POST', 
        body: JSON.stringify({ action, token: currentUser?.token, ...data }) 
      });
      return await res.json();
    } catch(e) { return { ok: false, msg: 'é€£ç·šéŒ¯èª¤' }; }
  }

  // ================= UI: UNIVERSAL NAV (BUTTONS) =================
  function renderNavButtons() {
    const box = document.getElementById('universalNav');
    box.innerHTML = '';
    const isDash = !document.getElementById('tabDash').classList.contains('hidden');
    
    // 1. "All Info" Button (Only shown in Dashboard mode)
    if (isDash) {
        const allBtn = document.createElement('button');
        const isAllActive = currentDashFilter === 'ALL';
        allBtn.className = `filter-btn`;
        if(isAllActive) {
            allBtn.style.background = '#334155';
            allBtn.style.color = '#fff';
            allBtn.style.borderColor = '#334155';
        }
        allBtn.textContent = 'å…¨éƒ¨æƒ…å ±';
        allBtn.onclick = () => { 
            currentDashFilter = 'ALL'; 
            renderNavButtons(); 
            renderDashboard(); 
        };
        box.appendChild(allBtn);
    }

    // 2. Sheet Buttons (Always shown, logic differs slightly)
    SHEET_CONFIGS.forEach(cfg => {
      const btn = document.createElement('button');
      // Determine Active State
      let isActive = false;
      if (isDash) {
          isActive = currentDashFilter === cfg.key;
      } else {
          isActive = currentSheetName === cfg.key;
      }

      btn.className = `filter-btn`;
      if(isActive) {
        btn.style.backgroundColor = cfg.color;
        btn.style.borderColor = cfg.color;
        btn.style.color = '#fff';
      } else {
        btn.style.color = cfg.color;
        btn.style.borderColor = cfg.color;
      }
      btn.textContent = cfg.key;
      
      btn.onclick = () => { 
        if (isDash) {
            currentDashFilter = cfg.key;
            renderDashboard();
        } else {
            currentSheetName = cfg.key;
            activeFilter = null; // Clear filter when switching sheets
            renderList();
        }
        renderNavButtons(); // Re-render to update active styling
      };
      box.appendChild(btn);
    });
  }

  // ================= UI: DASHBOARD =================
  function renderDashboard() {
    const container = document.getElementById('dashContent');
    container.innerHTML = '';

    SHEET_CONFIGS.forEach(cfg => {
      if(currentDashFilter !== 'ALL' && currentDashFilter !== cfg.key) return;

      const data = allData[cfg.key];
      if(!data || !data.headers) return; 

      const wrapper = document.createElement('div');
      wrapper.className = 'dash-section';
      wrapper.innerHTML = `<div class="dash-title" style="color:${cfg.color}; border-color:${cfg.color}">${cfg.key}</div>`;

      const steps = cfg.steps;
      const parkingStep = cfg.parkingField;
      const parkingIdx = steps.indexOf(parkingStep);
      
      const inbound = parkingIdx >= 0 ? steps.slice(0, parkingIdx) : steps;
      const outbound = parkingIdx >= 0 ? steps.slice(parkingIdx + 1) : [];

      inbound.forEach(step => wrapper.appendChild(createStatCard(step, data, cfg)));

      // Location Stats Only (Detailed list removed as requested)
      if(parkingStep) {
        // Stats Grid
        const locContainer = document.createElement('div');
        locContainer.className = 'loc-container';
        const colIdx = data.headers.findIndex(h => h.name === parkingStep);
        const counts = {};
        STOP_OPTIONS.forEach(s => counts[s] = 0);
        
        data.rows.forEach(r => {
          const val = (r[colIdx] || '').trim();
          if(counts[val] !== undefined) counts[val]++;
        });
        
        STOP_OPTIONS.forEach(loc => {
          const card = document.createElement('div');
          card.className = 'loc-card';
          card.innerHTML = `<div class="loc-name">${loc}</div><div class="loc-val">${counts[loc]}</div>`;
          // Click to Manage Location
          if(currentUser.permission === 'ADMIN' || currentUser.permission === 'LEADER') {
             card.onclick = () => openLocationSheet(loc, cfg.key);
          }
          locContainer.appendChild(card);
        });
        wrapper.appendChild(locContainer);
      }

      if(outbound.length > 0) {
        const outTitle = document.createElement('div');
        outTitle.className = 'step-header';
        outTitle.style.marginTop = '16px';
        outTitle.textContent = 'é€€å ´ç¨‹åº';
        wrapper.appendChild(outTitle);
        outbound.forEach(step => wrapper.appendChild(createStatCard(step, data, cfg)));
      }

      const dynamicHeaders = data.headers.filter(h => h.isDynamic);
      if(dynamicHeaders.length > 0) {
        const summaryBox = createSummaryTable(data, dynamicHeaders, cfg);
        if(summaryBox) wrapper.appendChild(summaryBox);
      }

      container.appendChild(wrapper);
    });
  }

  function createSummaryTable(data, dynamicHeaders, cfg) {
    const rows = [];
    const carIdx = data.headers.findIndex(h => h.name === 'è»Šè™Ÿ');
    const areaIdx = data.headers.findIndex(h => h.name.includes('å€åŸŸ') || h.name.includes('ç·¨è™Ÿ'));

    data.rows.forEach(r => {
      dynamicHeaders.forEach(dh => {
        const colIdx = data.headers.indexOf(dh);
        const val = (r[colIdx] || '').trim();
        if(val && val !== 'Skip' && val !== '-') {
          rows.push({ car: r[carIdx], area: r[areaIdx], station: dh.name, time: val });
        }
      });
    });

    if(rows.length === 0) return null;

    const box = document.createElement('div');
    box.className = 'stat-card'; 
    box.style.padding = '12px';
    let html = `<div class="dash-title" style="color:${cfg.color}; border-color:${cfg.color}; margin-top:0;">æ–°å¢ç«™é»ç´€éŒ„</div>
    <table class="summary-table">
      <tr><th>è»Šè™Ÿ</th><th>å€åŸŸ</th><th>åœ°é»</th><th>æ™‚é–“</th></tr>`;
    rows.forEach(r => {
      html += `<tr>
        <td style="font-weight:800;">${r.car}</td>
        <td style="font-weight:800; color:#000;">${r.area}</td> <td class="summary-loc">${r.station}</td> <td class="summary-time">${r.time}</td>
      </tr>`;
    });
    html += '</table>';
    box.innerHTML = html;
    return box;
  }

  function createStatCard(step, data, cfg) {
    const colIdx = data.headers.findIndex(h => h.name === step);
    let done = 0, todo = 0;
    data.rows.forEach(row => {
      const val = (row[colIdx] || '').trim();
      (val && val !== 'Skip' && val !== '-') ? done++ : todo++;
    });

    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `
      <div class="step-header">${step}</div>
      <div class="stat-row">
        <div class="stat-box" onclick="goToFilter('${cfg.key}', '${step}', 'done')">
          <div class="stat-num num-done">${done}</div>
          <div class="stat-lbl">å®Œæˆ</div>
        </div>
        <div class="stat-box" onclick="goToFilter('${cfg.key}', '${step}', 'todo')">
          <div class="stat-num num-todo" style="${todo===0?'color:#ccc':''}">${todo}</div>
          <div class="stat-lbl">æœªå®Œæˆ</div>
        </div>
      </div>`;
    return card;
  }

  // ================= UI: LIST (TAB 2) =================
  function renderList() {
    const data = allData[currentSheetName];
    if(!data || !data.headers) return;

    const container = document.getElementById('listContainer');
    container.innerHTML = '';
    const header = data.headers;
    const carIdx = header.findIndex(h => h.name === 'è»Šè™Ÿ');
    let areaIdx = header.findIndex(h => h.name === 'å€åŸŸè»Šæ¬¡ç·¨è™Ÿ');
    if (areaIdx === -1) areaIdx = header.findIndex(h => h.name.includes('å€åŸŸ'));

    let rows = data.rows;
    // Apply Filter
    if(activeFilter) {
      document.getElementById('filterMsg').classList.remove('hidden');
      document.getElementById('filterText').textContent = `ç¯©é¸: ${activeFilter.step} (${activeFilter.status === 'done' ? 'å®Œæˆ' : 'æœªå®Œæˆ'})`;
      const stepIdx = header.findIndex(h => h.name === activeFilter.step);
      rows = rows.filter(r => {
        const val = (r[stepIdx] || '').trim();
        const isDone = (val && val !== '-' && val !== 'Skip');
        return activeFilter.status === 'done' ? isDone : !isDone;
      });
    } else {
      document.getElementById('filterMsg').classList.add('hidden');
    }

    // Prepare rows
    const cfg = SHEET_CONFIGS.find(s => s.key === currentSheetName);
    const renderItems = rows.map((row, idx) => {
        // 1. Standard Progress & Latest Status
        let stdCompletedCount = 0;
        let latestStdTime = ''; 
        let displayStatus = null;
        
        cfg.steps.forEach(step => {
            const hIdx = header.findIndex(h => h.name === step);
            const val = (row[hIdx] || '').trim();
            if(val && val !== '-') {
                stdCompletedCount++;
                if(step === cfg.parkingField) {
                    displayStatus = `<div class="status-row">${val}</div>`;
                } else if(val === 'Skip') {
                    displayStatus = `<div class="status-row">${step} (ç•¥é)</div>`;
                } else {
                    displayStatus = `<div class="status-row">${step}</div><div class="status-row">${val}</div>`;
                    latestStdTime = val; 
                }
            }
        });

        if(!displayStatus) displayStatus = `<div class="status-row status-pending">å°šæœªé–‹å§‹</div>`;

        // 2. Dynamic Stations (Time > Latest Std Time)
        const dynamicHeaders = header.filter(h => h.isDynamic);
        let dynamicUpdates = [];
        
        dynamicHeaders.forEach(dh => {
            const hIdx = header.indexOf(dh);
            const val = (row[hIdx] || '').trim();
            if(val && val !== '-' && val !== 'Skip') {
                if(!latestStdTime || val > latestStdTime) {
                    dynamicUpdates.push({ name: dh.name, time: val });
                }
            }
        });
        dynamicUpdates.sort((a, b) => a.time.localeCompare(b.time));

        // 3. Construct Final HTML (Vertical Stack)
        let finalHtml = displayStatus;
        if(dynamicUpdates.length > 0) {
            finalHtml += `<div class="status-sep"></div>`;
            dynamicUpdates.forEach(u => {
                finalHtml += `<div class="status-row status-dynamic">${u.name} ${u.time}</div>`;
            });
        }

        const isAllDone = stdCompletedCount === cfg.steps.length;
        return { row, stdCompletedCount, finalHtml, isAllDone, originalIdx: idx };
    });

    // Sort: Standard Progress (Low -> High), then Index
    renderItems.sort((a, b) => {
        if (a.stdCompletedCount !== b.stdCompletedCount) return a.stdCompletedCount - b.stdCompletedCount;
        return a.originalIdx - b.originalIdx;
    });

    if(renderItems.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ç„¡ç¬¦åˆè³‡æ–™</div>';
      return;
    }

    renderItems.forEach(item => {
      const card = document.createElement('div');
      card.className = `veh-card ${item.isAllDone ? 'completed' : ''}`;
      const btnIcon = item.isAllDone ? 'âœ“' : '+';
      
      card.innerHTML = `
        <div class="veh-col-left">
            <div class="txt-car">${item.row[carIdx] || ''}</div>
            <div class="txt-area">${item.row[areaIdx] || ''}</div>
        </div>
        <div class="veh-col-mid">
            ${item.finalHtml}
        </div>
        <div class="btn-expand">${btnIcon}</div>
      `;
      card.onclick = () => openBottomSheet(item.row, header, carIdx, areaIdx);
      container.appendChild(card);
    });
  }

  // ================= MANAGERS =================
  function openBottomSheet(row, header, carIdx, areaIdx) {
    const title = document.getElementById('sheetTitle');
    title.textContent = `${row[carIdx]} ${row[areaIdx]}`;
    const body = document.getElementById('sheetBody');
    body.innerHTML = '';

    const cfg = SHEET_CONFIGS.find(s => s.key === currentSheetName);
    const isViewer = currentUser.permission === 'VIEWER';

    let allSteps = [...cfg.steps];
    const dynamicHeaders = header.filter(h => h.isDynamic).map(h => h.name);
    const standardCount = allSteps.length;
    allSteps = allSteps.concat(dynamicHeaders);

    allSteps.forEach((step, index) => {
      if(index === standardCount) {
        const sep = document.createElement('div'); sep.className = 'dynamic-sep';
        const head = document.createElement('div'); head.className = 'dynamic-title'; head.textContent = 'æ–°å¢ç«™é»';
        body.appendChild(sep);
        body.appendChild(head);
      }

      const hIdx = header.findIndex(h => h.name === step);
      const val = (row[hIdx] || '').trim();
      
      const rowDiv = document.createElement('div');
      rowDiv.className = 'action-row';
      const left = document.createElement('div');
      left.className = 'action-label';
      left.textContent = step;
      rowDiv.appendChild(left);

      const mid = document.createElement('div');
      mid.className = 'action-mid';
      
      const right = document.createElement('div');
      right.className = 'action-right';
      
      if(step === cfg.parkingField) {
        if(!isViewer) {
          const sel = document.createElement('select');
          sel.className = 'sheet-select';
          // UPDATED: Clear Option as Dashes
          sel.innerHTML = `<option value="">------------</option>` + STOP_OPTIONS.map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('');
          sel.onchange = () => doAction(row[carIdx], step, sel.value, true);
          right.appendChild(sel);
        } else {
          mid.innerHTML = `<span class="action-time" style="color:#000">${val || '-'}</span>`;
        }
      } 
      else {
        if(val && val !== 'Skip' && val !== '-') {
          mid.innerHTML = `<span class="action-time">${val}</span>`;
          if(!isViewer) {
             const div = document.createElement('div'); div.className = 'btn-group';
             div.innerHTML = `
               <button class="btn-solid btn-mod" onclick="modifyTime('${row[carIdx]}', '${step}', '${val}')">ä¿®æ”¹</button>
               <button class="btn-solid btn-del" onclick="doAction('${row[carIdx]}', '${step}', '')">åˆªé™¤</button>
             `;
             right.appendChild(div);
          }
        } else if(val === 'Skip' || val === '-') {
          mid.innerHTML = `<span class="action-skip">å·²ç•¥é</span>`;
          if(!isViewer) {
             const div = document.createElement('div'); div.className = 'btn-group';
             div.innerHTML = `
               <button class="btn-solid btn-mod" onclick="modifyTime('${row[carIdx]}', '${step}', '')">ä¿®æ”¹</button>
               <button class="btn-solid btn-del" onclick="doAction('${row[carIdx]}', '${step}', '')">åˆªé™¤</button>
             `;
             right.appendChild(div);
          }
        } else {
          if(!isViewer) {
            const div = document.createElement('div'); div.className = 'btn-group';
            div.innerHTML = `
              <button class="btn-solid btn-do" onclick="doAction('${row[carIdx]}', '${step}', null)">æ‰“å¡</button>
              <button class="btn-solid btn-skip" onclick="doAction('${row[carIdx]}', '${step}', '-')">ç•¥é</button>
            `;
            right.appendChild(div);
          }
        }
      }
      rowDiv.appendChild(mid);
      rowDiv.appendChild(right);
      body.appendChild(rowDiv);
    });

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('bottomSheet').classList.add('show');
  }

  // ================= LOCATION MANAGEMENT (TAB 1) =================
  function openLocationSheet(locName, sheetKey) {
    const title = document.getElementById('sheetTitle');
    title.textContent = `${locName}`; 
    const body = document.getElementById('sheetBody');
    body.innerHTML = '';

    const data = allData[sheetKey];
    if(!data) return;
    
    const cfg = SHEET_CONFIGS.find(s => s.key === sheetKey);
    const parkingField = cfg.parkingField;
    const parkingIdx = data.headers.findIndex(h => h.name === parkingField);
    const carIdx = data.headers.findIndex(h => h.name === 'è»Šè™Ÿ');
    
    let areaIdx = data.headers.findIndex(h => h.name === 'å€åŸŸè»Šæ¬¡ç·¨è™Ÿ');
    if (areaIdx === -1) areaIdx = data.headers.findIndex(h => h.name.includes('å€åŸŸ') || h.name.includes('ç·¨è™Ÿ'));

    // 1. Current Vehicles List
    const currentVehicles = data.rows.filter(r => (r[parkingIdx] || '').trim() === locName);
    
    body.innerHTML += `<div class="action-label" style="margin-bottom:8px;">ç¾æœ‰è»Šè¼› (${currentVehicles.length})</div>`;
    
    if(currentVehicles.length === 0) {
        body.innerHTML += `<div style="padding:10px; color:#999;">ç„¡è»Šè¼›</div>`;
    } else {
        currentVehicles.forEach(r => {
            const div = document.createElement('div');
            div.className = 'loc-list-item';
            div.innerHTML = `
                <div class="loc-list-txt">${r[carIdx]} ${r[areaIdx]}</div>
                <button class="btn-remove-loc" onclick="doAssignLoc('${sheetKey}', '${r[carIdx]}', '${parkingField}', '')">ç§»é™¤</button>
            `;
            body.appendChild(div);
        });
    }

    // 2. Add Vehicle Section (Admin/Leader only)
    const sep = document.createElement('div'); sep.className = 'dynamic-sep';
    const head = document.createElement('div'); head.className = 'dynamic-title'; head.textContent = 'åŠ å…¥è»Šè¼›';
    body.appendChild(sep);
    body.appendChild(head);

    const candidates = data.rows.filter(r => {
        const val = (r[parkingIdx] || '').trim();
        return !val || val === '-';
    });

    if(candidates.length > 0) {
        const sel = document.createElement('select');
        sel.id = 'selAddLocCar';
        sel.className = 'sheet-select';
        sel.style.marginBottom = '12px';
        sel.innerHTML = `<option value="">è«‹é¸æ“‡è»Šè¼›</option>` + 
            candidates.map(r => `<option value="${r[carIdx]}">${r[carIdx]} ${r[areaIdx]}</option>`).join('');
        
        const btn = document.createElement('button');
        btn.className = 'btn-solid btn-do';
        btn.style.width = '100%';
        btn.textContent = 'ç¢ºå®šåŠ å…¥';
        btn.onclick = () => {
            const carNo = document.getElementById('selAddLocCar').value;
            if(!carNo) return alert('è«‹é¸æ“‡è»Šè¼›');
            doAssignLoc(sheetKey, carNo, parkingField, locName);
        };

        body.appendChild(sel);
        body.appendChild(btn);
    } else {
        body.innerHTML += `<div style="color:#999;">ç„¡å¯åŠ å…¥çš„è»Šè¼›</div>`;
    }

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('bottomSheet').classList.add('show');
  }

  async function doAssignLoc(sheetKey, carNo, colName, value) {
    const originalSheet = currentSheetName;
    currentSheetName = sheetKey; 
    await doAction(carNo, colName, value, true);
    currentSheetName = originalSheet; 
  }

  // ================= ACTIONS =================
  async function doAction(carNo, colName, value, isUpdate = false) {
    document.getElementById('loading').style.display = 'flex';
    closeSheet();
    const action = isUpdate ? 'update' : 'stamp';
    await callApi(action, { sheetName: currentSheetName, carNo, colName, value });
    await loadAllData(true);
  }

  function modifyTime(carNo, step, oldVal) {
    const newVal = prompt('ä¿®æ”¹æ™‚é–“:', oldVal || '');
    if(newVal !== null) doAction(carNo, step, newVal, true);
  }

  function promptAddColumn() {
    const name = prompt("è«‹è¼¸å…¥æ–°ç«™é»åç¨±:");
    if(name) {
      document.getElementById('loading').style.display = 'flex';
      callApi('addColumn', { sheetName: currentSheetName, colName: name }).then(() => loadAllData(true));
    }
  }

  function switchTab(tab) {
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    const btns = document.querySelectorAll('.nav-tab');
    if(tab === 'dash') btns[0].classList.add('active');
    else btns[1].classList.add('active');
    
    if(tab === 'dash') {
      document.getElementById('tabDash').classList.remove('hidden');
      document.getElementById('tabOp').classList.add('hidden');
    } else {
      document.getElementById('tabDash').classList.add('hidden');
      document.getElementById('tabOp').classList.remove('hidden');
      renderList(); 
    }
    // Re-render buttons because "All Info" is only for Dash
    renderNavButtons();
  }

  function goToFilter(sheetKey, step, status) {
    currentSheetName = sheetKey;
    activeFilter = { step, status };
    currentDashFilter = sheetKey; // Sync filter view
    switchTab('op'); // This will trigger renderList() and renderNavButtons()
  }

  function clearFilter() { activeFilter = null; renderList(); }
  
  function closeSheet() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('bottomSheet').classList.remove('show');
  }

  function renderRefreshCtrl() {
    const box = document.getElementById('refreshCtrl');
    box.innerHTML = REFRESH_OPTIONS.map(opt => 
      `<button class="refresh-btn ${refreshMs===opt.ms?'active':''}" onclick="setRefresh(${opt.ms})">${opt.label}</button>`
    ).join('');
  }

  function setRefresh(ms) { refreshMs = ms; renderRefreshCtrl(); startTimer(); }
  function startTimer() { if(refreshTimer) clearInterval(refreshTimer); refreshTimer = setInterval(() => loadAllData(false), refreshMs); }
  function logout() { localStorage.removeItem('ddcc_user_token'); location.reload(); }
</script>
</body>
</html>
