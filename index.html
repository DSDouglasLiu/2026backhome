<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>2026 è»Šæµé€€å ´ä½œæ¥­ç³»çµ±</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* =========================================
       1. Design Tokens (æ•´åˆ token.css & Primitive CSV)
       ========================================= */
    :root {
      /* Palette */
      --color-brand-500: #3B82F6;
      --color-brand-600: #2563EB;
      --color-success-500: #22C55E;
      --color-success-100: #dcfce7;
      --color-warning-500: #F59E0B;
      --color-bg-app-shell: #f8fafc;
      --color-surface: #ffffff;
      --color-text-main: #0f172a;
      --color-text-sub: #64748b;
      --color-border: #e2e8f0;
      
      /* Spacing & Radius */
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --radius-md: 12px;
      --radius-lg: 16px;
      
      /* Layers (Z-Index) */
      --layer-tabbar: 100;
      --layer-overlay: 1000;
      --layer-bottom-sheet: 1100;
    }

    /* =========================================
       2. App Shell (æ•´åˆ style.css)
       ========================================= */
    body { 
      margin: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      background: var(--color-bg-app-shell); 
      color: var(--color-text-main); 
      padding-bottom: 80px; /* Safe area for scrolling */
      -webkit-tap-highlight-color: transparent;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: var(--spacing-md); }
    
    .header { 
      display: flex; justify-content: space-between; align-items: center; 
      margin-bottom: var(--spacing-md); 
      background: var(--color-surface);
      padding: 12px;
      border-radius: var(--radius-md);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    select { 
      padding: 8px 12px; border: 1px solid var(--color-border); 
      border-radius: 6px; font-size: 1rem; max-width: 200px;
    }

    button.nav-btn {
      padding: 8px 12px; background: white; border: 1px solid var(--color-border);
      border-radius: 6px; cursor: pointer; color: var(--color-text-main);
    }

    /* =========================================
       3. RWD Views (Card vs Table)
       ========================================= */
    .view-card { display: block; }
    .view-table { display: none; }
    
    @media (min-width: 768px) {
      .view-card { display: none; }
      .view-table { display: block; }
    }

    /* Card Style (Mobile) */
    .card { 
      background: var(--color-surface); 
      border-radius: var(--radius-md); 
      padding: var(--spacing-md); 
      margin-bottom: 12px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    .card-head { 
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; font-weight: 700; font-size: 1.1rem; 
      border-bottom: 1px solid var(--color-border);
      padding-bottom: 8px;
    }
    .status-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); 
      gap: 8px; 
    }

    /* Table Style (Desktop) */
    table { width: 100%; border-collapse: collapse; background: var(--color-surface); }
    th, td { border: 1px solid var(--color-border); padding: 10px; text-align: center; font-size: 0.9rem; }
    th { background: #f1f5f9; font-weight: 600; white-space: nowrap; }

    /* =========================================
       4. Status Components
       ========================================= */
    .btn-status { 
      padding: 8px 4px; 
      border-radius: 8px; 
      border: 1px solid var(--color-border); 
      background: #f8fafc; 
      font-size: 0.85rem; 
      cursor: pointer; 
      text-align: center;
      min-height: 48px; /* Touch friendly */
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .btn-status strong { display: block; font-size: 0.75rem; color: var(--color-text-sub); margin-bottom: 2px; }
    .btn-status span { font-weight: 600; font-size: 0.9rem; }
    
    /* State: Done */
    .btn-status.done { 
      background: var(--color-success-100); 
      color: #166534; 
      border-color: #bbf7d0; 
    }
    /* State: Skip */
    .btn-status.skip { 
      background: #f1f5f9; 
      color: #94a3b8; 
      text-decoration: line-through; 
    }
    /* State: Dynamic (Temporary) */
    .is-dynamic { 
      border: 2px dashed var(--color-warning-500); 
      background: #fffbeb;
    }

    /* =========================================
       5. Bottom Sheet & Overlays
       ========================================= */
    .overlay { 
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
      display: none; z-index: var(--layer-overlay); 
      backdrop-filter: blur(2px);
    }
    .bottom-sheet { 
      position: fixed; bottom: -100%; left: 0; right: 0; 
      background: var(--color-surface); 
      border-radius: var(--radius-lg) var(--radius-lg) 0 0; 
      padding: 24px; 
      transition: bottom 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
      z-index: var(--layer-bottom-sheet); 
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    }
    .sheet-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 20px; text-align: center; }
    .sheet-actions { display: flex; flex-direction: column; gap: 12px; }
    
    .btn-lg { 
      padding: 14px; border-radius: 12px; border: none; 
      font-size: 1rem; font-weight: 600; cursor: pointer; 
      display: flex; align-items: center; justify-content: center;
    }
    .btn-primary { background: var(--color-brand-500); color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
    .btn-outline { background: transparent; border: 1px solid var(--color-border); color: var(--color-text-main); }
    .btn-ghost { background: transparent; color: var(--color-text-sub); }

    /* Loading */
    .loading { 
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
      background: rgba(0,0,0,0.8); color: white; padding: 16px 24px; 
      border-radius: 8px; display: none; z-index: 2000; font-weight: bold;
    }
  </style>
</head>
<body>

<div id="loading" class="loading">è³‡æ–™è™•ç†ä¸­...</div>

<div id="loginView" style="display:flex; height:100vh; justify-content:center; align-items:center; flex-direction:column; background: #fff;">
  <h2 style="color: var(--color-brand-600); margin-bottom: 24px;">2026 è»Šæµé€€å ´ä½œæ¥­</h2>
  <div id="g_id_onload"
       data-client_id="368914333961-tr57ogs6ig2cgfqqi5j5ml6h2ic67cd1.apps.googleusercontent.com" 
       data-callback="handleCredentialResponse"
       data-auto_select="true">
  </div>
  <div class="g_id_signin" data-type="standard" data-size="large" data-theme="outline"></div>
</div>

<div id="appView" style="display:none;">
  <div class="container">
    <div class="header">
      <select id="sheetSelector" onchange="loadData()">
        <option value="åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰">åœ°å€å°ˆè»Šé€€å ´ï¼ˆéŠè¦½è»Šå¹³å°ï¼‰</option>
        <option value="åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰">åœ°å€å°ˆè»Šé€€å ´ï¼ˆç¦ªå ‚å¹³å°ï¼‰</option>
        <option value="æ°´é™¸å°ˆè»Šé€€å ´">æ°´é™¸å°ˆè»Šé€€å ´</option>
        <option value="288æ³•é’é€€å ´">288æ³•é’é€€å ´</option>
      </select>
      <div style="display:flex; gap:8px;">
        <button id="btnAddCol" class="nav-btn" onclick="promptAddColumn()" style="display:none; color:var(--color-warning-500); border-color:var(--color-warning-500);">+ ç«™é»</button>
        <button class="nav-btn" onclick="logout()">ç™»å‡º</button>
      </div>
    </div>

    <div id="cardContainer" class="view-card"></div>
    
    <div class="view-table">
      <table id="dataTable">
        <thead><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="overlay" id="overlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-title" id="sheetTitle">æ“ä½œé¸å–®</div>
  <div class="sheet-actions">
    <button class="btn-lg btn-primary" onclick="doStamp()">
      <span>ğŸ•’ ç«‹å³æ‰“å¡ (ç¾åœ¨)</span>
    </button>
    
    <div style="display:flex; gap:12px;">
      <input type="time" id="manualTime" class="btn-lg btn-outline" style="flex:1; font-family:inherit;">
      <button class="btn-lg btn-outline" style="flex:1;" onclick="doUpdate()">æ›´æ–°æ™‚é–“</button>
    </div>
    
    <button class="btn-lg btn-outline" onclick="doSkip()" style="color: var(--color-text-sub);">
      ğŸš« ç•¥éæ­¤ç«™ (Skip)
    </button>
    <button class="btn-lg btn-ghost" onclick="closeSheet()">å–æ¶ˆ</button>
  </div>
</div>

<script>
  // ==========================================
  // 1. è¨­å®šèˆ‡å…¨åŸŸè®Šæ•¸
  // ==========================================
  
  // è«‹ç¢ºèªé€™æ˜¯ä½ æœ€æ–°éƒ¨ç½²çš„ Web App URL (çµå°¾æ˜¯ /exec)
  // æ³¨æ„ï¼šæ¯æ¬¡ä¿®æ”¹å¾Œç«¯ç¨‹å¼ç¢¼ï¼Œéƒ½å¿…é ˆã€Œå»ºç«‹æ–°éƒ¨ç½² (New Version)ã€ç¶²å€æ‰æœƒæ›´æ–°é‚è¼¯
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzjKiKHUA4uO29bTj80_pRRbGdgbsBMsKmkJoTy31ZUU4cuy-Gcx3Oafb-FRaXBBPjT/exec';
  
  let currentUser = null;
  let currentSheetData = null;
  let activeTarget = null; // { carNo, colName }

  // ==========================================
  // 2. æ ¸å¿ƒé€šè¨Šå±¤ (å–ä»£ google.script.run)
  // ==========================================
  
  /**
   * é€šç”¨ API å‘¼å«å‡½å¼
   * ä½¿ç”¨ fetch ç™¼é€ POST è«‹æ±‚çµ¦ GAS
   */
  async function callApi(action, data = {}) {
    // æº–å‚™å‚³é€çš„è³‡æ–™åŒ…
    const payload = {
      action: action,
      userEmail: currentUser ? currentUser.email : '',
      ...data
    };

    console.log(`[API Call] ${action}`, payload);

    try {
      // ä½¿ç”¨ fetch ç™¼é€è«‹æ±‚
      // æ³¨æ„ï¼šGAS doPost é›–ç„¶æ”¯æ´ CORSï¼Œä½†å»ºè­°ä¸è¦è¨­å®š 'Content-Type': 'application/json'
      // å› ç‚ºé€™æœƒè§¸ç™¼ Preflight (OPTIONS) æª¢æŸ¥ï¼Œå°è‡´ GAS å ±éŒ¯ã€‚
      // ç›´æ¥å‚³é€ Stringified JSONï¼Œç€è¦½å™¨æœƒé è¨­ç‚º text/plainï¼ŒGAS å¾Œç«¯ä¸€æ¨£è®€å¾—åˆ°ã€‚
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      });

      const result = await response.json();
      console.log(`[API Result]`, result);
      return result;

    } catch (err) {
      console.error('Fetch Error:', err);
      return { ok: false, msg: 'ç¶²è·¯é€£ç·šå¤±æ•—æˆ–å¾Œç«¯ç„¡å›æ‡‰' };
    }
  }

  // ==========================================
  // 3. Google ç™»å…¥è™•ç†
  // ==========================================
  
  function handleCredentialResponse(response) {
    try {
      const idToken = response.credential;
      // è§£æ JWT Token å–å¾—ä½¿ç”¨è€…è³‡è¨Š
      const base64Url = idToken.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      const payload = JSON.parse(jsonPayload);
      
      // æš«å­˜ä½¿ç”¨è€…è³‡è¨Š
      currentUser = { 
        email: payload.email, 
        name: payload.name, 
        picture: payload.picture,
        token: idToken 
      }; 

      console.log('User detected:', currentUser.email);
      document.getElementById('loading').style.display = 'block';

      // å‘¼å«å¾Œç«¯ verify æª¢æŸ¥æ¬Šé™ (ä½¿ç”¨æ–°çš„ fetch callApi)
      callApi('verify').then(res => {
        document.getElementById('loading').style.display = 'none';
        
        if (res.ok) {
          currentUser.permission = res.permission;
          console.log('Permission:', res.permission);

          // åˆ‡æ›ç•«é¢
          document.getElementById('loginView').style.display = 'none';
          document.getElementById('appView').style.display = 'block';
          
          // æ ¹æ“šæ¬Šé™é¡¯ç¤ºæŒ‰éˆ•
          if (['ADMIN', 'LEADER'].includes(res.permission)) {
             document.getElementById('btnAddCol').style.display = 'inline-block';
          }

          // è¼‰å…¥è³‡æ–™
          loadData();
        } else {
          alert('ç™»å…¥å¤±æ•—: ' + (res.msg || 'æœªçŸ¥éŒ¯èª¤'));
          currentUser = null; // æ¸…é™¤å¤±æ•—çš„ç™»å…¥
        }
      });

    } catch (e) {
      console.error(e);
      alert('ç™»å…¥è§£æç™¼ç”ŸéŒ¯èª¤');
    }
  }

  function logout() {
    currentUser = null;
    location.reload();
  }

  // ==========================================
  // 4. è³‡æ–™è¼‰å…¥èˆ‡æ¸²æŸ“
  // ==========================================

  function loadData() {
    const sheetName = document.getElementById('sheetSelector').value;
    document.getElementById('loading').style.display = 'block';
    
    callApi('getData', { sheetName: sheetName }).then(res => {
      document.getElementById('loading').style.display = 'none';
      if(res.ok) {
        currentSheetData = res;
        render(res);
      } else {
        alert('è®€å–å¤±æ•—: ' + res.msg);
      }
    });
  }

  function render(data) {
    const { headers, rows } = data;
    const container = document.getElementById('cardContainer');
    const thead = document.getElementById('tableHead');
    const tbody = document.getElementById('tableBody');
    
    container.innerHTML = '';
    thead.innerHTML = '';
    tbody.innerHTML = '';

    const infoCols = ['ç·¨è™Ÿ', 'å€åŸŸè»Šæ¬¡ç·¨è™Ÿ', 'è»Šè™Ÿ', 'å‚™è¨»'];

    // 1. Render Table Header
    headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h.name;
      thead.appendChild(th);
    });

    // 2. Render Rows
    rows.forEach(row => {
      const carNoIdx = headers.findIndex(h => h.name === 'è»Šè™Ÿ');
      const carNo = row[carNoIdx] || 'Unknown';
      const noteIdx = headers.findIndex(h => h.name === 'å‚™è¨»');
      const note = row[noteIdx] || '';
      
      // -- Mobile Card --
      const card = document.createElement('div');
      card.className = 'card';
      let gridHtml = '';
      
      card.innerHTML = `
        <div class="card-head">
          <span style="font-size:1.2rem; color:var(--color-brand-600)">${carNo}</span>
          <span style="font-size:0.85rem; color:var(--color-text-sub); font-weight:normal">${note}</span>
        </div>`;

      // -- Desktop Table Row --
      const tr = document.createElement('tr');

      headers.forEach((h, idx) => {
        const val = row[idx] || '';
        const isDynamic = h.isDynamic;
        const isInfo = infoCols.includes(h.name);
        
        const cellClass = `btn-status ${val ? 'done' : ''} ${val==='-' || val==='Skip' ? 'skip' : ''} ${isDynamic ? 'is-dynamic' : ''}`;
        const clickAttr = isInfo ? '' : `onclick="openSheet('${carNo}', '${h.name}')"`;
        
        // Grid Item (Mobile)
        if (!isInfo) {
          gridHtml += `
            <div class="${cellClass}" ${clickAttr}>
              <strong>${h.name}</strong>
              <span>${val || '-'}</span>
            </div>`;
        }

        // Table Cell (Desktop)
        const td = document.createElement('td');
        if(!isInfo) {
          td.innerHTML = `<div class="${cellClass}" ${clickAttr}><span>${val || ''}</span></div>`;
        } else {
          td.textContent = val;
        }
        tr.appendChild(td);
      });

      card.innerHTML += `<div class="status-grid">${gridHtml}</div>`;
      container.appendChild(card);
      tbody.appendChild(tr);
    });
  }

  // ==========================================
  // 5. æ“ä½œé‚è¼¯
  // ==========================================

  function openSheet(carNo, colName) {
    // ç°¡å–®é˜²å‘†
    if(!currentUser || currentUser.permission === 'VIEWER') {
      // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦è¦æç¤ºï¼Œæˆ–ä¹¾è„†æ²’åæ‡‰
      return; 
    }

    activeTarget = { carNo, colName };
    document.getElementById('sheetTitle').textContent = `${carNo} : ${colName}`;
    
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    document.getElementById('manualTime').value = `${hh}:${mm}`;

    document.getElementById('overlay').style.display = 'block';
    document.getElementById('bottomSheet').style.bottom = '0';
  }

  function closeSheet() {
    document.getElementById('overlay').style.display = 'none';
    document.getElementById('bottomSheet').style.bottom = '-100%';
    activeTarget = null;
  }

  function doStamp() {
    sendAction('stamp', null);
  }

  function doUpdate() {
    const val = document.getElementById('manualTime').value;
    if(!val) return alert('è«‹é¸æ“‡æ™‚é–“');
    sendAction('update', val);
  }

  function doSkip() {
    sendAction('stamp', '-');
  }
  
  function promptAddColumn() {
    const name = prompt("è«‹è¼¸å…¥æ–°ç«™é»åç¨± (å°‡æ–°å¢è‡³æœ€å¾Œ):");
    if(name) {
      const sheetName = document.getElementById('sheetSelector').value;
      document.getElementById('loading').style.display = 'block';
      
      callApi('addColumn', { sheetName, colName: name }).then(res => {
        document.getElementById('loading').style.display = 'none';
        if(res.ok) { 
          alert('æ–°å¢æˆåŠŸ'); 
          loadData(); 
        } else { 
          alert('å¤±æ•—: ' + res.msg); 
        }
      });
    }
  }

  function sendAction(actType, val) {
    if(!activeTarget) return;
    const sheetName = document.getElementById('sheetSelector').value;
    
    const payload = {
      sheetName,
      carNo: activeTarget.carNo,
      colName: activeTarget.colName,
      value: val
    };

    document.getElementById('loading').style.display = 'block';
    closeSheet();

    callApi(actType, payload).then(res => {
      document.getElementById('loading').style.display = 'none';
      if(res.ok) {
        // æˆåŠŸå¾Œé‡æ–°è®€å–è³‡æ–™ä»¥æ›´æ–°ç•«é¢
        loadData(); 
      } else {
        alert('Error: ' + res.msg);
      }
    });
  }
</script>
</body>
</html>
